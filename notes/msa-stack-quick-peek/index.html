<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>MSA 개발 스택 빠르게 훑어보기 | minjun's memory</title><meta name=keywords content="MSA,API-First,CI/CD,Message-Queue"><meta name=description content="1. 요구사항 아주 간단한 웹 기반 ITunes 주요 데이터는 다음과 같다. 가수 (Singer) 이름 정보를 가진다. 앨범 (Album) 발매 날짜, 앨범 제목 정보를 가진다. 노래 (Song) 노래 제목과 재생 시간 정보를 가진다. 공통 데이터 생성 시간 업데이트 시간 생성한 사람 업데이트한 사람 주요 기능 가수를 등록할 수 있다. 앨범을 등록할 수 있다. 노래를 등록할 수 있다. 노래 목록들을 조회할 수 있다. 노래를 조회할 수 있다. 노래를 업데이트 할 수 있다. 노래를 삭제할 수 있다."><meta name=author content="조민준"><link rel=canonical href=https://jo-minjun.github.io/notes/msa-stack-quick-peek/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://jo-minjun.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jo-minjun.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jo-minjun.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jo-minjun.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jo-minjun.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="MSA 개발 스택 빠르게 훑어보기"><meta property="og:description" content="1. 요구사항 아주 간단한 웹 기반 ITunes 주요 데이터는 다음과 같다. 가수 (Singer) 이름 정보를 가진다. 앨범 (Album) 발매 날짜, 앨범 제목 정보를 가진다. 노래 (Song) 노래 제목과 재생 시간 정보를 가진다. 공통 데이터 생성 시간 업데이트 시간 생성한 사람 업데이트한 사람 주요 기능 가수를 등록할 수 있다. 앨범을 등록할 수 있다. 노래를 등록할 수 있다. 노래 목록들을 조회할 수 있다. 노래를 조회할 수 있다. 노래를 업데이트 할 수 있다. 노래를 삭제할 수 있다."><meta property="og:type" content="article"><meta property="og:url" content="https://jo-minjun.github.io/notes/msa-stack-quick-peek/"><meta property="article:section" content="notes"><meta property="article:published_time" content="2022-12-28T17:10:30+09:00"><meta property="article:modified_time" content="2022-12-28T17:10:30+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="MSA 개발 스택 빠르게 훑어보기"><meta name=twitter:description content="1. 요구사항 아주 간단한 웹 기반 ITunes 주요 데이터는 다음과 같다. 가수 (Singer) 이름 정보를 가진다. 앨범 (Album) 발매 날짜, 앨범 제목 정보를 가진다. 노래 (Song) 노래 제목과 재생 시간 정보를 가진다. 공통 데이터 생성 시간 업데이트 시간 생성한 사람 업데이트한 사람 주요 기능 가수를 등록할 수 있다. 앨범을 등록할 수 있다. 노래를 등록할 수 있다. 노래 목록들을 조회할 수 있다. 노래를 조회할 수 있다. 노래를 업데이트 할 수 있다. 노래를 삭제할 수 있다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Notes","item":"https://jo-minjun.github.io/notes/"},{"@type":"ListItem","position":3,"name":"MSA 개발 스택 빠르게 훑어보기","item":"https://jo-minjun.github.io/notes/msa-stack-quick-peek/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"MSA 개발 스택 빠르게 훑어보기","name":"MSA 개발 스택 빠르게 훑어보기","description":"1. 요구사항 아주 간단한 웹 기반 ITunes 주요 데이터는 다음과 같다. 가수 (Singer) 이름 정보를 가진다. 앨범 (Album) 발매 날짜, 앨범 제목 정보를 가진다. 노래 (Song) 노래 제목과 재생 시간 정보를 가진다. 공통 데이터 생성 시간 업데이트 시간 생성한 사람 업데이트한 사람 주요 기능 가수를 등록할 수 있다. 앨범을 등록할 수 있다. 노래를 등록할 수 있다. 노래 목록들을 조회할 수 있다. 노래를 조회할 수 있다. 노래를 업데이트 할 수 있다. 노래를 삭제할 수 있다.","keywords":["MSA","API-First","CI/CD","Message-Queue"],"articleBody":"1. 요구사항 아주 간단한 웹 기반 ITunes 주요 데이터는 다음과 같다. 가수 (Singer) 이름 정보를 가진다. 앨범 (Album) 발매 날짜, 앨범 제목 정보를 가진다. 노래 (Song) 노래 제목과 재생 시간 정보를 가진다. 공통 데이터 생성 시간 업데이트 시간 생성한 사람 업데이트한 사람 주요 기능 가수를 등록할 수 있다. 앨범을 등록할 수 있다. 노래를 등록할 수 있다. 노래 목록들을 조회할 수 있다. 노래를 조회할 수 있다. 노래를 업데이트 할 수 있다. 노래를 삭제할 수 있다. 엔티티 Class 2. 프로젝트 scaffolding 섀시 패턴 아래와 같은 프로젝트들의 공통 관심사를 편리하게 설정할 수 있다. health check 패턴: actuator 개발 생산성 확보: spring-configuration-processor, lombok, mapstruct: 로깅 패턴: logback, request - response 로깅 추적 패턴: B3 Propagation(Sleuth), Sentry 적용 로컬 개발 환경: docker-compose를 이용한 local cluster 구성 (UAA + MySQL + Kafka + …) Persistence: QueryDSL, JPA Specification integration API-First: OpenApi Generator 및 Zalando problem details 연동 Scheduler: ShedLock 연동 Security: UAA 및 리소스 서버 통합 CI / CD: 도커 이미지 빌드, 젠킨스 연동 msa-bootcamp 프로젝트 세팅 (Meshkorea) git clone https://github.com/meshkorea/msa-starter.git\nstarter project를 clone한다. cd msa-starter \u0026\u0026 ./gradlew generate\n위 명령어를 수행하면 아래와 같은 세팅 메세지가 나온다. Starting a Gradle Daemon (subsequent builds will be faster) \u003e Task :getBuildInfo \u003e WebMVC/JPA 프로젝트인가요(m)? WebFlux/R2DBC 프로젝트인가요(f) (default: m)? \u003c====---------\u003e 33% EXECUTING [17s] \u003e 부릉 프로젝트입니까(y/n, default: n)?: \u003c====---------\u003e 33% EXECUTING [27s] \u003e 사용하려는 자바 버전은 무엇입니까(1.8/11, default: 11)?: \u003c====---------\u003e 33% EXECUTING [31s] 11 \u003e 프로젝트 이름은 무엇입니까(default: example)? \u003c====---------\u003e 33% EXECUTING [35s] \u003e 그룹 이름은 무엇입니까(default: com.vroong)? \u003c====---------\u003e 33% EXECUTING [38s] \u003e 웹 서버 포트는 무엇입니까(default: 8080)? \u003c====---------\u003e 33% EXECUTING [42s] \u003e 웹 요청 및 응답에 사용할 미디어 타입은 무엇입니까(default: application/vnd.vroong.private.v1+json)? \u003c====---------\u003e 33% EXECUTING [47s] 진행할까요('n' to quit)? [osArch:intel, projectType:v, projectName:example, groupName:com.vroong, packageName:com.vroong.example, portNumber:8080, mediaType:application/vnd.vroong.private.v1+json, javaVersion:11, dockerImage:amazoncorretto:11-alpine-jdk, skipTokens:[.DS_Store]] \u003c====---------\u003e 33% EXECUTING [50s] \u003e Task :generate cp -r build {path-to-your-project}\ncd {path-to-your-project} \u0026\u0026 ./gradlew clean build\ngit init\n로컬 개발 환경 구동 방법 JDK 설치 corretto11 jhipster-uaa 세팅 msa-starter 디렉토리의 jhipster-uaa.zip을 해제한다. cd jhipster-uaa \u0026\u0026 ./gradlew jibDockerBuild -Djib.to.image=jhipster-uaa -Djib.to.tags=latest 로컬에서는 jhipster-uaa를 사용하지만, EKS에 올렸을 때는 이미 구동중인 vroong-uaa를 사용한다. 도커 구동 ./gradlew clusterUp MySQL (3306) Kafka (9092) jhipster-uaa (9999) 애플리케이션 구동 3. API-First 개발 방법론 API-First 개발 방법론 API를 중심으로 제품을 설계하는 방법이다. API는 중요한 비즈니스 요소이며, 개발 조직에 API를 제공하는 것이 높은 우선순위를 가진다고 인식하는 것이다. API-First 장점 일관성 제공 API-First 도구를 사용하여 일관성 있는 설계 및 문서화를 통해 일관된 개발자 경험을 제공할 수 있도록 해준다. 병렬 개발 편의성 API를 먼저 설계하고 결과물로 나온 API Spec을 이용해서 서버 스켈레톤과 클라이언트 SDK(API 문서 + 클라이언트 라이브러리 Stub)를 생성할 수 있고 클라이언트와 서버가 생성된 코드를 이용해서 빠르게 개발을 시작할 수 있다. 개발 속도 향상 API-First 도구는 클라이언트 SDK를 생성해주고, 이를 사내 Repository에 공유할 수 있다. 개발자들은 Mock API를 사용함으로써, API가 완성되기 전에 클라이언트를 구축할 수 있다. 빠른 피드백 제공 클라이언트 개발자는 서버 개발자가 개발 완료 후 API를 제공할 때까지 기다리지 않고, API 문서와 Mock API를 이용하여 설계를 검토하고 검증해볼 수 있다. API-First 도구 - OAS (OpenApi Specification) OAS는 REST API를 위한 IDL(Interface Defintion Language) 이다. API 스펙 및 기능, 설명을 기술한다. OAS 파일은 YAML 또는 JSON으로 작성할 수 있다. OAS 파일은 아래 내용을 포함한 내용을 기술할 수 있다. API endpoint와 HTTP method (GET /users, POST /users 등) 각 API의 요청과 응답의 파라미터 인증 method 이용 방법, 라이센스, 연락처 등과 기타 정보 Swagger Editor/IDE plugin를 사용하면 OpenApi Specification의 문법 오류와 UI를 확인 할 수 있다. OpenApi Generator의 특징 OpenApi Generator를 사용하면 서버의 코드 스켈레톤과 클라이언트의 SDK를 자동으로 생성해준다. 서버 스켈레톤은 각 API에 대한 기술없이, 구현만 해주면 된다. JAVA 뿐만 아니라 PHP, GO, C++, C#, Python, Ruby, Typescript 등 대부분의 언어를 지원한다. API Interface 뿐만 아니라 model도 구현해주고, 정규 표현식 또는 다른 제한을 validation 까지 해준다. 브라우저에서 사용자가 직접 호출해볼 수 있는 interactive API 문서를 만들어 준다. Ex) Swagger Editor OAS 문법 https://swagger.io/docs/specification/basic-structure/\n간단한 OAS 예시\nopenapi: \"3.0.1\" info: title: \"msa-bootcamp\" version: 1.0.0 servers: - url: http://localhost:8080 description: Local server paths: /api/singers: post: description: create an singer operationId: createSinger tags: - Singer requestBody: description: singer model content: application/vnd.vroong.private.v1+json: schema: $ref: \"#/components/schemas/CreateSingerRequest\" responses: \"201\": $ref: \"#/components/responses/Created\" \"400\": $ref: \"#/components/responses/BadRequest\" \"401\": $ref: \"#/components/responses/Unauthorized\" \"403\": $ref: \"#/components/responses/Forbidden\" \"500\": $ref: \"#/components/responses/ServerError\" components: schemas: CommonProperties: type: object properties: createdAt: $ref: \"#/components/schemas/DateTime\" updatedAt: $ref: \"#/components/schemas/DateTime\" createdBy: $ref: \"#/components/schemas/UUID\" updatedBy: $ref: \"#/components/schemas/UUID\" Page: type: object properties: size: type: integer format: int32 default: 20 example: 20 totalElements: type: integer format: int64 example: 100 totalPages: type: integer format: int32 example: 5 number: type: integer format: int32 default: 1 example: 1 CreateSingerRequest: type: object required: - name properties: name: type: string Singer: allOf: - $ref: \"#/components/schemas/CommonProperties\" - type: object properties: singerId: $ref: \"#/components/schemas/LongId\" name: type: string 서버 코드 스켈레톤 생성 및 클라이언트 SDK 생성 OpenApi Generator를 사용한다.\nhttps://openapi-generator.tech/docs/installation 서버 코드 스켈레톤 생성\n아래와 같이 gradle이 정의되어 있어야 한다. plugin { id 'org.openapi.generator' version '4.3.1' } openApiGenerate { generatorName = 'spring' inputSpec = \"$rootDir/src/main/resources/swagger/api.yml\".toString() outputDir = \"$buildDir/openapi\".toString() apiPackage = 'com.vroong.msabootcamp.api' modelPackage = 'com.vroong.msabootcamp.api.model' modelNameSuffix = \"Dto\" apiFilesConstrainedTo = [\"\"] modelFilesConstrainedTo = [\"\"] supportingFilesConstrainedTo = [\"ApiUtil.java\"] configOptions = [ delegatePattern: \"true\", title: \"msabootcamp\", useTags: \"true\", dateLibrary: \"java8\", java8: \"true\", hideGenerationTimestamp: \"true\" ] validateSpec = true } sourceSets { main { java { srcDir file(\"${project.buildDir.path}/openapi/src/main/java\") } } } ./gradlew openApiGenerate Stub을 생성하면 아래의 파일이 생성된다. model에는 OAS에서 정의한 schema를 가진 DTO가 있다. 클라이언트 SDK 빌드 및 배포\n./gradlew :clients:clean :clients:publish -Dorg.gradle.internal.publish.checksums.insecure=true # 배포 결과는 https://nexus.mm.meshkorea.net/ 에서 확인할 수 있습니다. 4. Controller 작성 서버 코드 스켈레톤을 이용해서 controller를 구현한다. SingerApi\n/** * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech) (5.3.0). * https://openapi-generator.tech * Do not edit the class manually. */ @javax.annotation.Generated(value = \"org.openapitools.codegen.languages.SpringCodegen\") @Validated @Api(value = \"Singer\", description = \"the Singer API\") public interface SingerApi { default SingerApiDelegate getDelegate() { return new SingerApiDelegate() {}; } /** * POST /api/singers * create an singer * * @param createSingerRequestDto singer model (optional) * @return Created (status code 201) * or Bad Request (status code 400) * or Unauthorized (status code 401) * or Forbidden (status code 403) * or Internal Server Error (status code 500) */ @ApiOperation(value = \"\", nickname = \"createSinger\", notes = \"create an singer\", authorizations = { @Authorization(value = \"jhipster-uaa\", scopes = { }), @Authorization(value = \"jhipster-uaa\", scopes = { }) }, tags={ \"Singer\", }) @ApiResponses(value = { @ApiResponse(code = 201, message = \"Created\"), @ApiResponse(code = 400, message = \"Bad Request\", response = ProblemDetailsDto.class), @ApiResponse(code = 401, message = \"Unauthorized\", response = ProblemDetailsDto.class), @ApiResponse(code = 403, message = \"Forbidden\", response = ProblemDetailsDto.class), @ApiResponse(code = 500, message = \"Internal Server Error\", response = ProblemDetailsDto.class) }) @RequestMapping( method = RequestMethod.POST, value = \"/api/singers\", produces = { \"application/problem+json\" }, consumes = { \"application/vnd.vroong.private.v1+json\" } ) default ResponseEntity\u003cVoid\u003e createSinger(@ApiParam(value = \"singer model\") @Valid @RequestBody(required = false) CreateSingerRequestDto createSingerRequestDto) { return getDelegate().createSinger(createSingerRequestDto); } } SingerApiController\n@javax.annotation.Generated(value = \"org.openapitools.codegen.languages.SpringCodegen\") @Controller @RequestMapping(\"${openapi.msabootcamp.base-path:}\") public class SingerApiController implements SingerApi { private final SingerApiDelegate delegate; public SingerApiController(@org.springframework.beans.factory.annotation.Autowired(required = false) SingerApiDelegate delegate) { this.delegate = Optional.ofNullable(delegate).orElse(new SingerApiDelegate() {}); } @Override public SingerApiDelegate getDelegate() { return delegate; } } SingerApiDelegate\n/** * A delegate to be called by the {@link SingerApiController}}. * Implement this interface with a {@link org.springframework.stereotype.Service} annotated class. */ @javax.annotation.Generated(value = \"org.openapitools.codegen.languages.SpringCodegen\") public interface SingerApiDelegate { default Optional\u003cNativeWebRequest\u003e getRequest() { return Optional.empty(); } /** * POST /api/singers * create an singer * * @param createSingerRequestDto singer model (optional) * @return Created (status code 201) * or Bad Request (status code 400) * or Unauthorized (status code 401) * or Forbidden (status code 403) * or Internal Server Error (status code 500) * @see SingerApi#createSinger */ default ResponseEntity\u003cVoid\u003e createSinger(CreateSingerRequestDto createSingerRequestDto) { return new ResponseEntity\u003c\u003e(HttpStatus.NOT_IMPLEMENTED); } } SingerApiDeleateImpl\n@RequiredArgsConstructor @Component public class SingerApiDelegateImpl implements SingerApiDelegate { private final SingerService singerService; @Override public ResponseEntity\u003cVoid\u003e createSinger(CreateSingerRequestDto createSingerRequestDto) { SingerDto singerDto = singerService.createSinger(createSingerRequestDto); return ResponseEntity .created(HeaderUtils.uri(String.valueOf(singerDto.getSingerId()))) .build(); } } 5. Messaging 이벤트 메세지 또는 커맨드 메세지를 이용하여 상호간에 통신하는 방식 이벤트 이미 일어난 정보에 대한 메세지이다. immutable 하다. producer는 이벤트의 comsumer가 누구인지, 무엇을 하는지 모른다. ex) 신규 물품이 입고되었을 때 필요한 시스템만 이벤트를 구독한다. 신규 물품이 입고된 것은 이미 일어난 사건이다. 커맨드 수행할 작업에 대한 하나의 시스템에서 다른 시스템으로의 메세지 미래에 발생할 사건의 트리거가 된다. 메시징을 사용하는 이유 REST API는 클라이언트가 요청하는 시점에 서버가 항상 가용해야 하는 문제가 있다. REST와 같은 동기 IPC (Inter Process Communication) 문제점을 해결하고자 비동기 메시징을 사용한다. 메시지 브로커가 가용하다면 consumer의 장애 시점에도 producer가 발행한 메시지는 메시지 브로커에 적재되며, consumer가 장애에서 복구되면 메시지를 소비할 수 있다. Transactional Outbox Pattern 메시징을 통해 데이터를 처리할 때 데이터의 일관성을 처리하기 위해 사용한다. producer 역할을 하는 서비스에서 발생한 도메인 이벤트/메시지는 적어도 한번(at least once) 발행해야 한다. 방법 producer 역할을 하는 서비스에 OUTBOX 테이블을 생성하고, 도메인 이벤트/메시지를 트랜잭션 범위안에서 OUTBOX 테이블에 insert한다. 별도의 MessageRelay가 주기적으로 OUTBOX 테이블에 있는 메세지를 발행한다. MessageRelay는 polling publisher로 구현할 수 있다. 데이터베이스 트랜잭션이 커밋된 경우에만 MessageRelay를 통해서 메시지를 발행한다. MessageRelay를 통하기 때문에 메세지 발행에 시차는 생기지만, Eventual Consistency를 유지한다. 멱등 수신자 (Idempotent Receiver) consumer 역할을 하는 서비스는 동일한 메시지를 중복으로 여러번 수신할 수 있으므로, 중복 메시지로 인한 사이드 이펙트가 발생하지 않도록 멱등 수신자를 구현해야 한다. 방법 PROCESSED_MESSAGE 테이블을 추가한다. 메세지를 수신하면 식별자를 이용해서 테이블에서 조회한다. 테이블에서 조회된다면 메세지를 무시한다. 조회되지 않는 메세지면 PROCESSED_MESSAGE에 저장하고 처리한다. (메세지 식별자에 unique 제약조건을 걸어서 구분할 수도 있다.) Kafka 코드 application.yml\nspring: cloud: stream: kafka: binder: headers: [\"messageId\", \"messageType\", \"messageVersion\", \"messageSource\"] auto-create-topics: false # Kafka - SASL_SSL설정과 SCRAM-SHA-512 를 이용한 ID Password 설정 # @see https://wiki.mm.meshkorea.net/pages/viewpage.action?pageId=95856174 configuration: sasl: jaas: config: 'org.apache.kafka.common.security.plain.PlainLoginModule required username=\"alice\" password=\"alice-secret\";' mechanism: PLAIN security: protocol: SASL_PLAINTEXT bindings: messageChannel: binder: kafka destination: local-msabootcamp-output producer: # @see https://docs.spring.io/spring-cloud-stream-binder-kafka/docs/3.0.10.RELEASE/reference/html/spring-cloud-stream-binder-kafka.html#kafka-producer-properties header-mode: headers partition-key-expression: headers['partitionKey'] partition-count: 1 subscribableChannel: binder: kafka destination: local-msabootcamp-output content-type: application/json consumer: header-mode: embeddedHeaders checkpointMode: record default-binder: kafka spring.cloud.stream.kafka.binder 를 이용해서 KafkaBinderConfigurationProperties.class 의 값을 세팅 PersistentEventCreator.class\npublic class PersistentEventCreator { private final PersistentEventRepository repository; private final ObjectMapper objectMapper; @Transactional public void create(String eventType, Object source) { String body = \"\"; try { body = objectMapper.writeValueAsString(source); } catch (IOException e) { log.error(\"Serialization failed\", e); } final PersistentEvent entity = PersistentEvent.newInstance(eventType, UUID.randomUUID(), body); repository.save(entity); } } PersistentEventPublisher.class - publish()\n@Transactional @Scheduled(fixedDelayString = \"PT50S\", initialDelayString = \"PT10S\") @SchedulerLock(name = \"PersistentEventPublisher\") @Async public void publish() { final Instant timeScope = Instant.now(Clock.system(ZONE_ID)).minus(1, ChronoUnit.MINUTES); List\u003cPersistentEvent\u003e candidates = repository.findUnproducedByTimeScope(timeScope); // OUTBOX 조회 if (candidates.isEmpty()) { return; } writeLog(\"started\", kv(\"total\", candidates.size())); int success = 0; for (PersistentEvent candidate : candidates) { try { boolean produced = producer.produce(candidate); // produce if (produced) { candidate.markProduced(); success++; writeLog(\"handling\", kv(\"persistentEventId\", candidate.getId()), kv(\"eventType\", candidate.getEventType()), kv(\"eventId\", candidate.getEventId()) ); } else { throw new RuntimeException(\"Message was not produced\"); } } catch (Exception e) { candidate.markFailed(); reportError(e, kv(\"persistentEventId\", candidate.getId())); } } writeLog(\"success\", kv(\"success\", success), kv(\"total\", candidates.size())); } MessageProducer.class\npublic class MessageProducer { private final MessageChannel messageChannel; public boolean produce(PersistentEvent persistentEvent) { final String body = persistentEvent.getBody(); Message\u003c?\u003e message = MessageBuilder .withPayload(body) .setHeader(MessageKey.ID, persistentEvent.getEventId()) .setHeader(MessageKey.TYPE, persistentEvent.getEventType()) .setHeader(MessageKey.VERSION, 1) .setHeader(MessageKey.SOURCE, PROJECT_NAME) .setHeader(MessageKey.RESOURCE, body.getClass().getSimpleName()) .setHeader(MessageKey.PARTITION_KEY, persistentEvent.getPartitionKey()) .build(); log.debug(\"Event publish: {}\", message); return messageChannel.send(message, MessagePolicy.DEFAULT_TIMEOUT); } } MessageSubscriber.class\npublic class MessageSubscriber { private final ReceivedEventRepository receivedEventRepository; @StreamListener(value = ConsumerChannel.CHANNEL) public void subscribe(Message\u003cAlbum\u003e event) { UUID messageId = event.getHeaders().getId(); Optional\u003cReceivedEvent\u003e receivedEvent = receivedEventRepository.findByMessageId(messageId); if (receivedEvent.isPresent()) { log.info(\"Duplicated event: {}\", receivedEvent.get().getMessageId()); return; } receivedEventRepository.save(new ReceivedEvent(event.getHeaders().getId())); log.debug(\"Event received: {}\", event.getPayload()); } } 전체 흐름 6. CI/CD CI/CD란 CI (Continuous Integration): 애플리케이션의 소스 변경 사항이 지속적으로 빌드 및 테스트되어 공유 리포지토리에 통합되는 것이다. CD (Continuous Delivery/Deployment): 변경 사항을 테스트 또는 프로덕션 환경에 지속적으로 배포하는 것이다. Jenkinsfile jenkins는 CI 도구이다.\n빌드 → 테스트 → 코드 분석 → 도커 이미지 빌드 → helm chart 빌드 위 과정을 파이프라인으로 자동화 해준다. 파이프라인은 Job들을 순차적 또는 병렬적으로 실행시키거나 작성한 스크립드로 이벤트를 연속적으로 실행시키는 것이다.\n@Library('meshkorea') _ vroongNeoMsaJavaPipeline( team: '', ecrRepoName: 'vroong/msabootcamp', argoAppName: 'vroong-msabootcamp', gradleBuildArguments: '' ) team: 슬랙 {team}-build-alerts 채널에 관련 alert를 발생시킨다. ecrRepoName: Jenkins에서 도커 빌드 후 push할 ECR 이름 argoAppName: argoCD 앱 이름 gradleBuildArguments: jar 파일 빌드시 뒤에 추가할 argument Jenkins 파이프라인 적용 방법\n리포지토리 root에 Jenkinsfile이 있어야만 파이프라인이 실행된다. github push, PR, merge 와 같은 이벤트 발생시 파이프라인이 구동된다. 도커 이미지 tag는 파이프라인에 도커 빌드 과정에서 {tag}-{commit hash} 형태로 빌드 후 ECR에 push된다. tag가 example이고, commit hash가 2d48cj3a인 경우 도커 이미지 tag는 example-2d48cj3a이다. Helm values Helm은 K8S 패키지 관리를 도와주는 패키지 매니저이다. ex) dev와 qa, prod 환경의 DB 주소가 다르다면 이를 관리해 주는 것이다. vroong-{appname}-helm-values 리포지토리 에 필요한 환경 변수 추가 위 리포지토리를 보면 다음과 같은 구조가 있다. dev1 prod qa1 ~ 4 values.yaml argoCD에서 helm values를 배포하면 K8S 서비스, deployment(replica set, pod), 서비스 account, config map 등의 리소스를 만들어준다. values.yaml 모든 환경에 동일하게 적용되어야 하는 내용이 선언되어 있다. 각 환경 별로 values.yaml 파일이 또 있다. 각 환경 별로 바인딩 되어야 하는 환경 변수를 선언한다. override하고 싶은 내용을 선언한다. 빌드 및 배포 과정 Start Init 저장소 checkout 후, commit hash를 구한다. 슬랙에 파이프라인 구동 메세지를 보낸다. Jenkinsfile에 작성한 값을 읽어낸다. Check the docker image ECR에 같은 tag를 가진 이미지가 있는지 확인한다. Gradle build nexus에 접근하기 위한 계정 정보를 복사한다. jar 파일을 빌드한다. code review / unit test sonarqube로 코드 리뷰를 하고 unit 테스트를 수행한다. Docker / ECR login 도커 이미지를 빌드하고 tag를 붙인다. ECR에 login한다. ECR push ECR에 도커 이미지를 push한다. ArgoCD trigger argoCD에 login한다. 슬랙에 빌드 완료 메세지를 보낸다. End Jenkins 과정을 거친 후 APP DIFF 버튼을 눌러, helm values 변경 사항을 확인한다.\n변경 사항에 이상이 없으면 SYNC 버튼을 누른다.\npod가 잘 교체 되는지 확인한다.\nk9s /{서비스 이름으로 검색} 상단 Context에서 현재 환경을 확인할 수 있다. 새로운 pod가 실행된 후 완료되면 기존 pod를 교체한다. 모니터링한다.\n7. UAA User Account and Authentication\nMSA Resource 서버를 보호하기 위한 Authorization Server\nOAuth2 (Open Authorization) 방식\nAuthorization Code Grant Type Resource Owner Password Grant type Client Credentials Grant Type Client Credentials Grant Type Flow https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2\u0026fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FAGn3b%2FbtqVyURyeZN%2F77J24Xr2Y3aAIZyLUsQZg1%2Fimg.png\nsecurity: oauth2: client: access-token-uri: http://localhost:9999/oauth/token user-authorization-uri: http://localhost:9999/oauth/token client-id: internal client-secret: internal scope: web-app grant-type: client_credentials authorized-grant-type: password, client_credentials, refresh_token resource: jwt.key-uri: http://localhost:9999/oauth/token_key ","wordCount":"2213","inLanguage":"en","datePublished":"2022-12-28T17:10:30+09:00","dateModified":"2022-12-28T17:10:30+09:00","author":[{"@type":"Person","name":"조민준"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://jo-minjun.github.io/notes/msa-stack-quick-peek/"},"publisher":{"@type":"Organization","name":"minjun's memory","logo":{"@type":"ImageObject","url":"https://jo-minjun.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jo-minjun.github.io accesskey=h title="minjun's memory (Alt + H)">minjun's memory</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://jo-minjun.github.io/search title=" (Alt + /)" accesskey=/><span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="23" y1="23" x2="16.65" y2="16.65"/></svg></span></a></li><li><a href=https://jo-minjun.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://jo-minjun.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://jo-minjun.github.io/notes/ title=Notes><span>Notes</span></a></li><li><a href=https://jo-minjun.github.io/etc/ title=끄적끄적><span>끄적끄적</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jo-minjun.github.io>Home</a>&nbsp;»&nbsp;<a href=https://jo-minjun.github.io/notes/>Notes</a></div><h1 class=post-title>MSA 개발 스택 빠르게 훑어보기</h1><div class=post-meta><span title='2022-12-28 17:10:30 +0900 +0900'>December 28, 2022</span>&nbsp;·&nbsp;조민준&nbsp;|&nbsp;<a href=https://github.com/jo-minjun/my-blog/issues/new rel="noopener noreferrer" target=_blank>변경 요청 &lt;-- 내용이 잘못되었다면?</a></div></header><br><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>목차 보기</span></summary><div class=inner><ul><li><a href=#1-%ec%9a%94%ea%b5%ac%ec%82%ac%ed%95%ad aria-label="1. 요구사항">1. 요구사항</a><ul><li><a href=#%ec%97%94%ed%8b%b0%ed%8b%b0-class aria-label="엔티티 Class">엔티티 Class</a></li></ul></li><li><a href=#2-%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8-scaffolding aria-label="2. 프로젝트 scaffolding">2. 프로젝트 scaffolding</a><ul><li><a href=#%ec%84%80%ec%8b%9c-%ed%8c%a8%ed%84%b4 aria-label="섀시 패턴">섀시 패턴</a></li><li><a href=#msa-bootcamp-%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8-%ec%84%b8%ed%8c%85-meshkorea aria-label="msa-bootcamp 프로젝트 세팅 (Meshkorea)">msa-bootcamp 프로젝트 세팅 (Meshkorea)</a></li><li><a href=#%eb%a1%9c%ec%bb%ac-%ea%b0%9c%eb%b0%9c-%ed%99%98%ea%b2%bd-%ea%b5%ac%eb%8f%99-%eb%b0%a9%eb%b2%95 aria-label="로컬 개발 환경 구동 방법">로컬 개발 환경 구동 방법</a></li></ul></li><li><a href=#3-api-first-%ea%b0%9c%eb%b0%9c-%eb%b0%a9%eb%b2%95%eb%a1%a0 aria-label="3. API-First 개발 방법론">3. API-First 개발 방법론</a><ul><li><a href=#api-first-%ea%b0%9c%eb%b0%9c-%eb%b0%a9%eb%b2%95%eb%a1%a0 aria-label="API-First 개발 방법론">API-First 개발 방법론</a></li><li><a href=#api-first-%ec%9e%a5%ec%a0%90 aria-label="API-First 장점">API-First 장점</a></li><li><a href=#api-first-%eb%8f%84%ea%b5%ac---oas-openapi-specification aria-label="API-First 도구 - OAS (OpenApi Specification)">API-First 도구 - OAS (OpenApi Specification)</a></li><li><a href=#openapi-generator%ec%9d%98-%ed%8a%b9%ec%a7%95 aria-label="OpenApi Generator의 특징">OpenApi Generator의 특징</a></li><li><a href=#oas-%eb%ac%b8%eb%b2%95 aria-label="OAS 문법">OAS 문법</a></li><li><a href=#%ec%84%9c%eb%b2%84-%ec%bd%94%eb%93%9c-%ec%8a%a4%ec%bc%88%eb%a0%88%ed%86%a4-%ec%83%9d%ec%84%b1-%eb%b0%8f-%ed%81%b4%eb%9d%bc%ec%9d%b4%ec%96%b8%ed%8a%b8-sdk-%ec%83%9d%ec%84%b1 aria-label="서버 코드 스켈레톤 생성 및 클라이언트 SDK 생성">서버 코드 스켈레톤 생성 및 클라이언트 SDK 생성</a></li></ul></li><li><a href=#4-controller-%ec%9e%91%ec%84%b1 aria-label="4. Controller 작성">4. Controller 작성</a></li><li><a href=#5-messaging aria-label="5. Messaging">5. Messaging</a><ul><li><a href=#%ec%9d%b4%eb%b2%a4%ed%8a%b8 aria-label=이벤트>이벤트</a></li><li><a href=#%ec%bb%a4%eb%a7%a8%eb%93%9c aria-label=커맨드>커맨드</a></li><li><a href=#%eb%a9%94%ec%8b%9c%ec%a7%95%ec%9d%84-%ec%82%ac%ec%9a%a9%ed%95%98%eb%8a%94-%ec%9d%b4%ec%9c%a0 aria-label="메시징을 사용하는 이유">메시징을 사용하는 이유</a></li><li><a href=#transactional-outbox-pattern aria-label="Transactional Outbox Pattern">Transactional Outbox Pattern</a></li><li><a href=#%eb%a9%b1%eb%93%b1-%ec%88%98%ec%8b%a0%ec%9e%90-idempotent-receiver aria-label="멱등 수신자 (Idempotent Receiver)">멱등 수신자 (Idempotent Receiver)</a></li><li><a href=#kafka-%ec%bd%94%eb%93%9c aria-label="Kafka 코드">Kafka 코드</a></li><li><a href=#%ec%a0%84%ec%b2%b4-%ed%9d%90%eb%a6%84 aria-label="전체 흐름">전체 흐름</a></li></ul></li><li><a href=#6-cicd aria-label="6. CI/CD">6. CI/CD</a><ul><li><a href=#cicd%eb%9e%80 aria-label=CI/CD란>CI/CD란</a></li><li><a href=#jenkinsfile aria-label=Jenkinsfile>Jenkinsfile</a></li><li><a href=#helm-values aria-label="Helm values">Helm values</a></li><li><a href=#%eb%b9%8c%eb%93%9c-%eb%b0%8f-%eb%b0%b0%ed%8f%ac-%ea%b3%bc%ec%a0%95 aria-label="빌드 및 배포 과정">빌드 및 배포 과정</a></li></ul></li><li><a href=#7-uaa aria-label="7. UAA">7. UAA</a></li></ul></div></details></div><div class=post-content><h2 id=1-요구사항>1. 요구사항<a hidden class=anchor aria-hidden=true href=#1-요구사항>#</a></h2><ul><li>아주 간단한 웹 기반 ITunes</li><li>주요 데이터는 다음과 같다.<ul><li>가수 (Singer)<ul><li>이름 정보를 가진다.</li></ul></li><li>앨범 (Album)<ul><li>발매 날짜, 앨범 제목 정보를 가진다.</li></ul></li><li>노래 (Song)<ul><li>노래 제목과 재생 시간 정보를 가진다.</li></ul></li><li>공통 데이터<ul><li>생성 시간</li><li>업데이트 시간</li><li>생성한 사람</li><li>업데이트한 사람</li></ul></li></ul></li><li>주요 기능<ul><li>가수를 등록할 수 있다.</li><li>앨범을 등록할 수 있다.</li><li>노래를 등록할 수 있다.</li><li>노래 목록들을 조회할 수 있다.</li><li>노래를 조회할 수 있다.</li><li>노래를 업데이트 할 수 있다.</li><li>노래를 삭제할 수 있다.</li></ul></li></ul><h3 id=엔티티-class>엔티티 Class<a hidden class=anchor aria-hidden=true href=#엔티티-class>#</a></h3><p><img loading=lazy src=../msa-stack-quick-peek/1.png alt=1></p><h2 id=2-프로젝트-scaffolding>2. 프로젝트 scaffolding<a hidden class=anchor aria-hidden=true href=#2-프로젝트-scaffolding>#</a></h2><h3 id=섀시-패턴>섀시 패턴<a hidden class=anchor aria-hidden=true href=#섀시-패턴>#</a></h3><ul><li>아래와 같은 프로젝트들의 공통 관심사를 편리하게 설정할 수 있다.<ul><li>health check 패턴: actuator</li><li>개발 생산성 확보: spring-configuration-processor, lombok, mapstruct:</li><li>로깅 패턴: logback, request - response 로깅</li><li>추적 패턴: B3 Propagation(Sleuth), Sentry 적용</li><li>로컬 개발 환경: docker-compose를 이용한 local cluster 구성 (UAA + MySQL + Kafka + …)</li><li>Persistence: QueryDSL, JPA Specification integration</li><li>API-First: OpenApi Generator 및 Zalando problem details 연동</li><li>Scheduler: ShedLock 연동</li><li>Security: UAA 및 리소스 서버 통합</li><li>CI / CD: 도커 이미지 빌드, 젠킨스 연동</li></ul></li></ul><h3 id=msa-bootcamp-프로젝트-세팅-meshkorea>msa-bootcamp 프로젝트 세팅 (Meshkorea)<a hidden class=anchor aria-hidden=true href=#msa-bootcamp-프로젝트-세팅-meshkorea>#</a></h3><ol><li><p><code>git clone https://github.com/meshkorea/msa-starter.git</code></p><ul><li>starter project를 clone한다.</li></ul></li><li><p><code>cd msa-starter && ./gradlew generate</code></p><ul><li>위 명령어를 수행하면 아래와 같은 세팅 메세지가 나온다.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Starting a Gradle Daemon <span style=color:#f92672>(</span>subsequent builds will be faster<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; Task :getBuildInfo
</span></span><span style=display:flex><span>&gt; WebMVC/JPA 프로젝트인가요<span style=color:#f92672>(</span>m<span style=color:#f92672>)</span>? WebFlux/R2DBC 프로젝트인가요<span style=color:#f92672>(</span>f<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>default: m<span style=color:#f92672>)</span>?
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>====</span>---------&gt; 33% EXECUTING <span style=color:#f92672>[</span>17s<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>&gt; 부릉 프로젝트입니까<span style=color:#f92672>(</span>y/n, default: n<span style=color:#f92672>)</span>?:
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>====</span>---------&gt; 33% EXECUTING <span style=color:#f92672>[</span>27s<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>&gt; 사용하려는 자바 버전은 무엇입니까<span style=color:#f92672>(</span>1.8/11, default: 11<span style=color:#f92672>)</span>?:
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>====</span>---------&gt; 33% EXECUTING <span style=color:#f92672>[</span>31s<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>&gt; 프로젝트 이름은 무엇입니까<span style=color:#f92672>(</span>default: example<span style=color:#f92672>)</span>?
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>====</span>---------&gt; 33% EXECUTING <span style=color:#f92672>[</span>35s<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>&gt; 그룹 이름은 무엇입니까<span style=color:#f92672>(</span>default: com.vroong<span style=color:#f92672>)</span>?
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>====</span>---------&gt; 33% EXECUTING <span style=color:#f92672>[</span>38s<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>&gt; 웹 서버 포트는 무엇입니까<span style=color:#f92672>(</span>default: 8080<span style=color:#f92672>)</span>?
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>====</span>---------&gt; 33% EXECUTING <span style=color:#f92672>[</span>42s<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>&gt; 웹 요청 및 응답에 사용할 미디어 타입은 무엇입니까<span style=color:#f92672>(</span>default: application/vnd.vroong.private.v1+json<span style=color:#f92672>)</span>?
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>====</span>---------&gt; 33% EXECUTING <span style=color:#f92672>[</span>47s<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>진행할까요<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;n&#39;</span> to quit<span style=color:#f92672>)</span>? <span style=color:#f92672>[</span>osArch:intel, projectType:v, projectName:example, groupName:com.vroong, packageName:com.vroong.example, portNumber:8080, mediaType:application/vnd.vroong.private.v1+json, javaVersion:11, dockerImage:amazoncorretto:11-alpine-jdk, skipTokens:<span style=color:#f92672>[</span>.DS_Store<span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>====</span>---------&gt; 33% EXECUTING <span style=color:#f92672>[</span>50s<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; Task :generate
</span></span></code></pre></div></li><li><p><code>cp -r build {path-to-your-project}</code></p></li><li><p><code>cd {path-to-your-project} && ./gradlew clean build</code></p></li><li><p><code>git init</code></p></li></ol><h3 id=로컬-개발-환경-구동-방법>로컬 개발 환경 구동 방법<a hidden class=anchor aria-hidden=true href=#로컬-개발-환경-구동-방법>#</a></h3><ol><li>JDK 설치<ul><li>corretto11</li></ul></li><li>jhipster-uaa 세팅<ol><li>msa-starter 디렉토리의 jhipster-uaa.zip을 해제한다.</li><li><code>cd jhipster-uaa && ./gradlew jibDockerBuild -Djib.to.image=jhipster-uaa -Djib.to.tags=latest</code></li><li>로컬에서는 jhipster-uaa를 사용하지만, EKS에 올렸을 때는 이미 구동중인 vroong-uaa를 사용한다.</li></ol></li><li>도커 구동<ul><li><code>./gradlew clusterUp</code></li><li>MySQL (3306)</li><li>Kafka (9092)</li><li>jhipster-uaa (9999)</li></ul></li><li>애플리케이션 구동</li></ol><h2 id=3-api-first-개발-방법론>3. API-First 개발 방법론<a hidden class=anchor aria-hidden=true href=#3-api-first-개발-방법론>#</a></h2><h3 id=api-first-개발-방법론>API-First 개발 방법론<a hidden class=anchor aria-hidden=true href=#api-first-개발-방법론>#</a></h3><ul><li>API를 중심으로 제품을 설계하는 방법이다.</li><li>API는 중요한 비즈니스 요소이며, 개발 조직에 API를 제공하는 것이 높은 우선순위를 가진다고 인식하는 것이다.</li></ul><h3 id=api-first-장점>API-First 장점<a hidden class=anchor aria-hidden=true href=#api-first-장점>#</a></h3><ul><li><strong>일관성 제공</strong><ul><li>API-First 도구를 사용하여 일관성 있는 설계 및 문서화를 통해 일관된 개발자 경험을 제공할 수 있도록 해준다.</li></ul></li><li><strong>병렬 개발 편의성</strong><ul><li>API를 먼저 설계하고 결과물로 나온 API Spec을 이용해서 서버 스켈레톤과 클라이언트 SDK(API 문서 + 클라이언트 라이브러리 Stub)를 생성할 수 있고 클라이언트와 서버가 생성된 코드를 이용해서 빠르게 개발을 시작할 수 있다.</li></ul></li><li><strong>개발 속도 향상</strong><ul><li>API-First 도구는 클라이언트 SDK를 생성해주고, 이를 사내 Repository에 공유할 수 있다.</li><li>개발자들은 Mock API를 사용함으로써, API가 완성되기 전에 클라이언트를 구축할 수 있다.</li></ul></li><li><strong>빠른 피드백 제공</strong><ul><li>클라이언트 개발자는 서버 개발자가 개발 완료 후 API를 제공할 때까지 기다리지 않고, API 문서와 Mock API를 이용하여 설계를 검토하고 검증해볼 수 있다.</li></ul></li></ul><p><img loading=lazy src=../msa-stack-quick-peek/2.png alt=2></p><h3 id=api-first-도구---oas-openapi-specification>API-First 도구 - OAS (OpenApi Specification)<a hidden class=anchor aria-hidden=true href=#api-first-도구---oas-openapi-specification>#</a></h3><ul><li>OAS는 REST API를 위한 IDL(Interface Defintion Language) 이다.<ul><li>API 스펙 및 기능, 설명을 기술한다.</li></ul></li><li>OAS 파일은 YAML 또는 JSON으로 작성할 수 있다.</li><li>OAS 파일은 아래 내용을 포함한 내용을 기술할 수 있다.<ul><li>API endpoint와 HTTP method (GET /users, POST /users 등)</li><li>각 API의 요청과 응답의 파라미터</li><li>인증 method</li><li>이용 방법, 라이센스, 연락처 등과 기타 정보</li></ul></li><li>Swagger Editor/IDE plugin를 사용하면 OpenApi Specification의 문법 오류와 UI를 확인 할 수 있다.</li></ul><h3 id=openapi-generator의-특징>OpenApi Generator의 특징<a hidden class=anchor aria-hidden=true href=#openapi-generator의-특징>#</a></h3><ul><li>OpenApi Generator를 사용하면 서버의 코드 스켈레톤과 클라이언트의 SDK를 자동으로 생성해준다.<ul><li>서버 스켈레톤은 각 API에 대한 기술없이, 구현만 해주면 된다.</li><li>JAVA 뿐만 아니라 PHP, GO, C++, C#, Python, Ruby, Typescript 등 대부분의 언어를 지원한다.</li><li>API Interface 뿐만 아니라 model도 구현해주고, 정규 표현식 또는 다른 제한을 validation 까지 해준다.</li></ul></li><li>브라우저에서 사용자가 직접 호출해볼 수 있는 interactive API 문서를 만들어 준다.<ul><li>Ex) Swagger Editor</li></ul></li></ul><h3 id=oas-문법>OAS 문법<a hidden class=anchor aria-hidden=true href=#oas-문법>#</a></h3><ul><li><p><a href=https://swagger.io/docs/specification/basic-structure/>https://swagger.io/docs/specification/basic-structure/</a></p></li><li><p>간단한 OAS 예시</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>openapi</span>: <span style=color:#e6db74>&#34;3.0.1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>info</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>title</span>: <span style=color:#e6db74>&#34;msa-bootcamp&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>1.0.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>servers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://localhost:8080</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Local server</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>/api/singers</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>post</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#ae81ff>create an singer</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>operationId</span>: <span style=color:#ae81ff>createSinger</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>Singer</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>requestBody</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>description</span>: <span style=color:#ae81ff>singer model</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>content</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>application/vnd.vroong.private.v1+json</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>schema</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/schemas/CreateSingerRequest&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>responses</span>:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;201&#34;</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/responses/Created&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;400&#34;</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/responses/BadRequest&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;401&#34;</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/responses/Unauthorized&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;403&#34;</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/responses/Forbidden&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;500&#34;</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/responses/ServerError&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>components</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>schemas</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>CommonProperties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>object</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>properties</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>createdAt</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/schemas/DateTime&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>updatedAt</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/schemas/DateTime&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>createdBy</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/schemas/UUID&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>updatedBy</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/schemas/UUID&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Page</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>object</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>properties</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>size</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>format</span>: <span style=color:#ae81ff>int32</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>default</span>: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>example</span>: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>totalElements</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>format</span>: <span style=color:#ae81ff>int64</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>example</span>: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>totalPages</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>format</span>: <span style=color:#ae81ff>int32</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>example</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>number</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>format</span>: <span style=color:#ae81ff>int32</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>default</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>example</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>CreateSingerRequest</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>object</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>required</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>name</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>properties</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Singer</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>allOf</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/schemas/CommonProperties&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>object</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>properties</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>singerId</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>$ref</span>: <span style=color:#e6db74>&#34;#/components/schemas/LongId&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span></code></pre></div></li></ul><h3 id=서버-코드-스켈레톤-생성-및-클라이언트-sdk-생성>서버 코드 스켈레톤 생성 및 클라이언트 SDK 생성<a hidden class=anchor aria-hidden=true href=#서버-코드-스켈레톤-생성-및-클라이언트-sdk-생성>#</a></h3><ul><li><p>OpenApi Generator를 사용한다.</p><ul><li><a href=https://openapi-generator.tech/docs/installation>https://openapi-generator.tech/docs/installation</a></li></ul></li><li><p>서버 코드 스켈레톤 생성</p><ul><li>아래와 같이 gradle이 정의되어 있어야 한다.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>plugin <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	id <span style=color:#e6db74>&#39;org.openapi.generator&#39;</span> version <span style=color:#e6db74>&#39;4.3.1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>openApiGenerate <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    generatorName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;spring&#39;</span>
</span></span><span style=display:flex><span>    inputSpec <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span>$rootDir<span style=color:#e6db74>/src/main/resources/swagger/api.yml&#34;</span>.toString<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    outputDir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span>$buildDir<span style=color:#e6db74>/openapi&#34;</span>.toString<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    apiPackage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;com.vroong.msabootcamp.api&#39;</span>
</span></span><span style=display:flex><span>    modelPackage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;com.vroong.msabootcamp.api.model&#39;</span>
</span></span><span style=display:flex><span>    modelNameSuffix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Dto&#34;</span>
</span></span><span style=display:flex><span>    apiFilesConstrainedTo <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    modelFilesConstrainedTo <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    supportingFilesConstrainedTo <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;ApiUtil.java&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    configOptions <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>            delegatePattern: <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>            title: <span style=color:#e6db74>&#34;msabootcamp&#34;</span>,
</span></span><span style=display:flex><span>            useTags: <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>            dateLibrary: <span style=color:#e6db74>&#34;java8&#34;</span>,
</span></span><span style=display:flex><span>            java8: <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>            hideGenerationTimestamp: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    validateSpec <span style=color:#f92672>=</span> true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sourceSets <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    main <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        java <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            srcDir file<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>project.buildDir.path<span style=color:#e6db74>}</span><span style=color:#e6db74>/openapi/src/main/java&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./gradlew openApiGenerate
</span></span></code></pre></div><ul><li>Stub을 생성하면 아래의 파일이 생성된다.
<img loading=lazy src=../msa-stack-quick-peek/3.png alt=3><ul><li>model에는 OAS에서 정의한 schema를 가진 DTO가 있다.</li></ul></li></ul></li><li><p>클라이언트 SDK 빌드 및 배포</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./gradlew :clients:clean :clients:publish -Dorg.gradle.internal.publish.checksums.insecure<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span><span style=color:#75715e># 배포 결과는 https://nexus.mm.meshkorea.net/ 에서 확인할 수 있습니다.</span>
</span></span></code></pre></div><h2 id=4-controller-작성>4. Controller 작성<a hidden class=anchor aria-hidden=true href=#4-controller-작성>#</a></h2><ul><li><p>서버 코드 스켈레톤을 이용해서 controller를 구현한다.
<img loading=lazy src=../msa-stack-quick-peek/4.png alt=4></p></li><li><p>SingerApi</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech) (5.3.0).
</span></span></span><span style=display:flex><span><span style=color:#75715e> * https://openapi-generator.tech
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Do not edit the class manually.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@javax.annotation.Generated</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;org.openapitools.codegen.languages.SpringCodegen&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Validated</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Api</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Singer&#34;</span><span style=color:#f92672>,</span> description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;the Singer API&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SingerApi</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span> SingerApiDelegate <span style=color:#a6e22e>getDelegate</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SingerApiDelegate<span style=color:#f92672>()</span> <span style=color:#f92672>{};</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * POST /api/singers
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * create an singer
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param createSingerRequestDto singer model (optional)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Created (status code 201)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         or Bad Request (status code 400)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         or Unauthorized (status code 401)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         or Forbidden (status code 403)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         or Internal Server Error (status code 500)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ApiOperation</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>,</span> nickname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;createSinger&#34;</span><span style=color:#f92672>,</span> notes <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;create an singer&#34;</span><span style=color:#f92672>,</span> authorizations <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Authorization</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jhipster-uaa&#34;</span><span style=color:#f92672>,</span> scopes <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>             <span style=color:#f92672>}),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Authorization</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jhipster-uaa&#34;</span><span style=color:#f92672>,</span> scopes <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>             <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>},</span> tags<span style=color:#f92672>={</span> <span style=color:#e6db74>&#34;Singer&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ApiResponses</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiResponse</span><span style=color:#f92672>(</span>code <span style=color:#f92672>=</span> <span style=color:#ae81ff>201</span><span style=color:#f92672>,</span> message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Created&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiResponse</span><span style=color:#f92672>(</span>code <span style=color:#f92672>=</span> <span style=color:#ae81ff>400</span><span style=color:#f92672>,</span> message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Bad Request&#34;</span><span style=color:#f92672>,</span> response <span style=color:#f92672>=</span> ProblemDetailsDto<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiResponse</span><span style=color:#f92672>(</span>code <span style=color:#f92672>=</span> <span style=color:#ae81ff>401</span><span style=color:#f92672>,</span> message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Unauthorized&#34;</span><span style=color:#f92672>,</span> response <span style=color:#f92672>=</span> ProblemDetailsDto<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiResponse</span><span style=color:#f92672>(</span>code <span style=color:#f92672>=</span> <span style=color:#ae81ff>403</span><span style=color:#f92672>,</span> message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Forbidden&#34;</span><span style=color:#f92672>,</span> response <span style=color:#f92672>=</span> ProblemDetailsDto<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ApiResponse</span><span style=color:#f92672>(</span>code <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span><span style=color:#f92672>,</span> message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Internal Server Error&#34;</span><span style=color:#f92672>,</span> response <span style=color:#f92672>=</span> ProblemDetailsDto<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>POST</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/api/singers&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        produces <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;application/problem+json&#34;</span> <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>        consumes <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;application/vnd.vroong.private.v1+json&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>createSinger</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@ApiParam</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;singer model&#34;</span><span style=color:#f92672>)</span> <span style=color:#a6e22e>@Valid</span> <span style=color:#a6e22e>@RequestBody</span><span style=color:#f92672>(</span>required <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span> CreateSingerRequestDto createSingerRequestDto<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getDelegate<span style=color:#f92672>().</span><span style=color:#a6e22e>createSinger</span><span style=color:#f92672>(</span>createSingerRequestDto<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li><li><p>SingerApiController</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@javax.annotation.Generated</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;org.openapitools.codegen.languages.SpringCodegen&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${openapi.msabootcamp.base-path:}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SingerApiController</span> <span style=color:#66d9ef>implements</span> SingerApi <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> SingerApiDelegate delegate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SingerApiController</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@org.springframework.beans.factory.annotation.Autowired</span><span style=color:#f92672>(</span>required <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span> SingerApiDelegate delegate<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>delegate</span> <span style=color:#f92672>=</span> Optional<span style=color:#f92672>.</span><span style=color:#a6e22e>ofNullable</span><span style=color:#f92672>(</span>delegate<span style=color:#f92672>).</span><span style=color:#a6e22e>orElse</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> SingerApiDelegate<span style=color:#f92672>()</span> <span style=color:#f92672>{});</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SingerApiDelegate <span style=color:#a6e22e>getDelegate</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li><li><p>SingerApiDelegate</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * A delegate to be called by the {@link SingerApiController}}.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Implement this interface with a {@link org.springframework.stereotype.Service} annotated class.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@javax.annotation.Generated</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;org.openapitools.codegen.languages.SpringCodegen&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SingerApiDelegate</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span> Optional<span style=color:#f92672>&lt;</span>NativeWebRequest<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getRequest</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Optional<span style=color:#f92672>.</span><span style=color:#a6e22e>empty</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * POST /api/singers
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * create an singer
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param createSingerRequestDto singer model (optional)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Created (status code 201)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         or Bad Request (status code 400)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         or Unauthorized (status code 401)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         or Forbidden (status code 403)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *         or Internal Server Error (status code 500)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @see SingerApi#createSinger
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>createSinger</span><span style=color:#f92672>(</span>CreateSingerRequestDto createSingerRequestDto<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ResponseEntity<span style=color:#f92672>&lt;&gt;(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>NOT_IMPLEMENTED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li><li><p>SingerApiDeleateImpl</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequiredArgsConstructor</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SingerApiDelegateImpl</span> <span style=color:#66d9ef>implements</span> SingerApiDelegate <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> SingerService singerService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>createSinger</span><span style=color:#f92672>(</span>CreateSingerRequestDto createSingerRequestDto<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    SingerDto singerDto <span style=color:#f92672>=</span> singerService<span style=color:#f92672>.</span><span style=color:#a6e22e>createSinger</span><span style=color:#f92672>(</span>createSingerRequestDto<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ResponseEntity
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>created</span><span style=color:#f92672>(</span>HeaderUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>singerDto<span style=color:#f92672>.</span><span style=color:#a6e22e>getSingerId</span><span style=color:#f92672>())))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li></ul><h2 id=5-messaging>5. Messaging<a hidden class=anchor aria-hidden=true href=#5-messaging>#</a></h2><ul><li>이벤트 메세지 또는 커맨드 메세지를 이용하여 상호간에 통신하는 방식</li></ul><h3 id=이벤트>이벤트<a hidden class=anchor aria-hidden=true href=#이벤트>#</a></h3><p><img loading=lazy src=../msa-stack-quick-peek/5.png alt=5></p><ul><li>이미 일어난 정보에 대한 메세지이다.</li><li>immutable 하다.</li><li>producer는 이벤트의 comsumer가 누구인지, 무엇을 하는지 모른다.</li><li>ex)<ul><li>신규 물품이 입고되었을 때 필요한 시스템만 이벤트를 구독한다.</li><li>신규 물품이 입고된 것은 이미 일어난 사건이다.</li></ul></li></ul><h3 id=커맨드>커맨드<a hidden class=anchor aria-hidden=true href=#커맨드>#</a></h3><p><img loading=lazy src=../msa-stack-quick-peek/6.png alt=6></p><ul><li>수행할 작업에 대한 하나의 시스템에서 다른 시스템으로의 메세지</li><li>미래에 발생할 사건의 트리거가 된다.</li></ul><h3 id=메시징을-사용하는-이유>메시징을 사용하는 이유<a hidden class=anchor aria-hidden=true href=#메시징을-사용하는-이유>#</a></h3><ul><li>REST API는 클라이언트가 요청하는 시점에 서버가 항상 가용해야 하는 문제가 있다.</li><li>REST와 같은 동기 IPC (Inter Process Communication) 문제점을 해결하고자 비동기 메시징을 사용한다.</li><li>메시지 브로커가 가용하다면 consumer의 장애 시점에도 producer가 발행한 메시지는 메시지 브로커에 적재되며, consumer가 장애에서 복구되면 메시지를 소비할 수 있다.</li></ul><h3 id=transactional-outbox-pattern>Transactional Outbox Pattern<a hidden class=anchor aria-hidden=true href=#transactional-outbox-pattern>#</a></h3><ul><li>메시징을 통해 데이터를 처리할 때 데이터의 일관성을 처리하기 위해 사용한다.</li><li>producer 역할을 하는 서비스에서 발생한 도메인 이벤트/메시지는 적어도 한번(at least once) 발행해야 한다.</li><li>방법<ol><li>producer 역할을 하는 서비스에 OUTBOX 테이블을 생성하고, 도메인 이벤트/메시지를 트랜잭션 범위안에서 OUTBOX 테이블에 insert한다.</li><li>별도의 MessageRelay가 주기적으로 OUTBOX 테이블에 있는 메세지를 발행한다.<ul><li>MessageRelay는 polling publisher로 구현할 수 있다.
<img loading=lazy src=../msa-stack-quick-peek/7.png alt=transactional-outbox-pattern.png></li></ul></li></ol></li><li>데이터베이스 트랜잭션이 커밋된 경우에만 MessageRelay를 통해서 메시지를 발행한다.</li><li>MessageRelay를 통하기 때문에 메세지 발행에 시차는 생기지만, Eventual Consistency를 유지한다.</li></ul><h3 id=멱등-수신자-idempotent-receiver>멱등 수신자 (Idempotent Receiver)<a hidden class=anchor aria-hidden=true href=#멱등-수신자-idempotent-receiver>#</a></h3><ul><li>consumer 역할을 하는 서비스는 동일한 메시지를 중복으로 여러번 수신할 수 있으므로, 중복 메시지로 인한 사이드 이펙트가 발생하지 않도록 멱등 수신자를 구현해야 한다.</li><li>방법<ol><li>PROCESSED_MESSAGE 테이블을 추가한다.</li><li>메세지를 수신하면 식별자를 이용해서 테이블에서 조회한다.</li><li>테이블에서 조회된다면 메세지를 무시한다.</li><li>조회되지 않는 메세지면 PROCESSED_MESSAGE에 저장하고 처리한다.</li></ol><ul><li>(메세지 식별자에 unique 제약조건을 걸어서 구분할 수도 있다.)
<img loading=lazy src=../msa-stack-quick-peek/8.png alt=idempotent-receiver.png></li></ul></li></ul><h3 id=kafka-코드>Kafka 코드<a hidden class=anchor aria-hidden=true href=#kafka-코드>#</a></h3><ul><li><p>application.yml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>stream</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>kafka</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>binder</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>            [<span style=color:#e6db74>&#34;messageId&#34;</span>, <span style=color:#e6db74>&#34;messageType&#34;</span>, <span style=color:#e6db74>&#34;messageVersion&#34;</span>, <span style=color:#e6db74>&#34;messageSource&#34;</span>]
</span></span><span style=display:flex><span>          <span style=color:#f92672>auto-create-topics</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># Kafka - SASL_SSL설정과 SCRAM-SHA-512 를 이용한 ID Password 설정</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># @see https://wiki.mm.meshkorea.net/pages/viewpage.action?pageId=95856174</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>configuration</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>sasl</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>jaas</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>config</span>: <span style=color:#e6db74>&#39;org.apache.kafka.common.security.plain.PlainLoginModule required username=&#34;alice&#34; password=&#34;alice-secret&#34;;&#39;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mechanism</span>: <span style=color:#ae81ff>PLAIN</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>security</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>SASL_PLAINTEXT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bindings</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>messageChannel</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>binder</span>: <span style=color:#ae81ff>kafka</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>destination</span>: <span style=color:#ae81ff>local-msabootcamp-output</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>producer</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># @see https://docs.spring.io/spring-cloud-stream-binder-kafka/docs/3.0.10.RELEASE/reference/html/spring-cloud-stream-binder-kafka.html#kafka-producer-properties</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>header-mode</span>: <span style=color:#ae81ff>headers</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>partition-key-expression</span>: <span style=color:#ae81ff>headers[&#39;partitionKey&#39;]</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>partition-count</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribableChannel</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>binder</span>: <span style=color:#ae81ff>kafka</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>destination</span>: <span style=color:#ae81ff>local-msabootcamp-output</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>content-type</span>: <span style=color:#ae81ff>application/json</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>consumer</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>header-mode</span>: <span style=color:#ae81ff>embeddedHeaders</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>checkpointMode</span>: <span style=color:#ae81ff>record</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>default-binder</span>: <span style=color:#ae81ff>kafka</span>
</span></span></code></pre></div><ul><li><code>spring.cloud.stream.kafka.binder</code> 를 이용해서 <code>KafkaBinderConfigurationProperties.class</code> 의 값을 세팅</li></ul></li><li><p>PersistentEventCreator.class</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PersistentEventCreator</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> PersistentEventRepository repository<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ObjectMapper objectMapper<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>String eventType<span style=color:#f92672>,</span> Object source<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String body <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      body <span style=color:#f92672>=</span> objectMapper<span style=color:#f92672>.</span><span style=color:#a6e22e>writeValueAsString</span><span style=color:#f92672>(</span>source<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Serialization failed&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> PersistentEvent entity <span style=color:#f92672>=</span> PersistentEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span>eventType<span style=color:#f92672>,</span> UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>(),</span> body<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    repository<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>entity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li><li><p>PersistentEventPublisher.class - publish()</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Scheduled</span><span style=color:#f92672>(</span>fixedDelayString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PT50S&#34;</span><span style=color:#f92672>,</span> initialDelayString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PT10S&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SchedulerLock</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PersistentEventPublisher&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Async</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>publish</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Instant timeScope <span style=color:#f92672>=</span> Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>(</span>Clock<span style=color:#f92672>.</span><span style=color:#a6e22e>system</span><span style=color:#f92672>(</span>ZONE_ID<span style=color:#f92672>)).</span><span style=color:#a6e22e>minus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> ChronoUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>MINUTES</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  List<span style=color:#f92672>&lt;</span>PersistentEvent<span style=color:#f92672>&gt;</span> candidates <span style=color:#f92672>=</span> repository<span style=color:#f92672>.</span><span style=color:#a6e22e>findUnproducedByTimeScope</span><span style=color:#f92672>(</span>timeScope<span style=color:#f92672>);</span> <span style=color:#75715e>// OUTBOX 조회
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>candidates<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  writeLog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;started&#34;</span><span style=color:#f92672>,</span> kv<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;total&#34;</span><span style=color:#f92672>,</span> candidates<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> success <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>PersistentEvent candidate <span style=color:#f92672>:</span> candidates<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>boolean</span> produced <span style=color:#f92672>=</span> producer<span style=color:#f92672>.</span><span style=color:#a6e22e>produce</span><span style=color:#f92672>(</span>candidate<span style=color:#f92672>);</span> <span style=color:#75715e>// produce
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>produced<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        candidate<span style=color:#f92672>.</span><span style=color:#a6e22e>markProduced</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        success<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>        writeLog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;handling&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            kv<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;persistentEventId&#34;</span><span style=color:#f92672>,</span> candidate<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>()),</span>
</span></span><span style=display:flex><span>            kv<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;eventType&#34;</span><span style=color:#f92672>,</span> candidate<span style=color:#f92672>.</span><span style=color:#a6e22e>getEventType</span><span style=color:#f92672>()),</span>
</span></span><span style=display:flex><span>            kv<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;eventId&#34;</span><span style=color:#f92672>,</span> candidate<span style=color:#f92672>.</span><span style=color:#a6e22e>getEventId</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Message was not produced&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      candidate<span style=color:#f92672>.</span><span style=color:#a6e22e>markFailed</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      reportError<span style=color:#f92672>(</span>e<span style=color:#f92672>,</span> kv<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;persistentEventId&#34;</span><span style=color:#f92672>,</span> candidate<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  writeLog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;success&#34;</span><span style=color:#f92672>,</span> kv<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;success&#34;</span><span style=color:#f92672>,</span> success<span style=color:#f92672>),</span> kv<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;total&#34;</span><span style=color:#f92672>,</span> candidates<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li><li><p>MessageProducer.class</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MessageProducer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> MessageChannel messageChannel<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>produce</span><span style=color:#f92672>(</span>PersistentEvent persistentEvent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> String body <span style=color:#f92672>=</span> persistentEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Message<span style=color:#f92672>&lt;?&gt;</span> message <span style=color:#f92672>=</span> MessageBuilder
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>withPayload</span><span style=color:#f92672>(</span>body<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>MessageKey<span style=color:#f92672>.</span><span style=color:#a6e22e>ID</span><span style=color:#f92672>,</span> persistentEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>getEventId</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>MessageKey<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE</span><span style=color:#f92672>,</span> persistentEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>getEventType</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>MessageKey<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>MessageKey<span style=color:#f92672>.</span><span style=color:#a6e22e>SOURCE</span><span style=color:#f92672>,</span> PROJECT_NAME<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>MessageKey<span style=color:#f92672>.</span><span style=color:#a6e22e>RESOURCE</span><span style=color:#f92672>,</span> body<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getSimpleName</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>MessageKey<span style=color:#f92672>.</span><span style=color:#a6e22e>PARTITION_KEY</span><span style=color:#f92672>,</span> persistentEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>getPartitionKey</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Event publish: {}&#34;</span><span style=color:#f92672>,</span> message<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> messageChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>message<span style=color:#f92672>,</span> MessagePolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT_TIMEOUT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li><li><p>MessageSubscriber.class</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MessageSubscriber</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ReceivedEventRepository receivedEventRepository<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@StreamListener</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> ConsumerChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>CHANNEL</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>subscribe</span><span style=color:#f92672>(</span>Message<span style=color:#f92672>&lt;</span>Album<span style=color:#f92672>&gt;</span> event<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    UUID messageId <span style=color:#f92672>=</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Optional<span style=color:#f92672>&lt;</span>ReceivedEvent<span style=color:#f92672>&gt;</span> receivedEvent <span style=color:#f92672>=</span> receivedEventRepository<span style=color:#f92672>.</span><span style=color:#a6e22e>findByMessageId</span><span style=color:#f92672>(</span>messageId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>receivedEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>isPresent</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Duplicated event: {}&#34;</span><span style=color:#f92672>,</span> receivedEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getMessageId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    receivedEventRepository<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ReceivedEvent<span style=color:#f92672>(</span>event<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Event received: {}&#34;</span><span style=color:#f92672>,</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>getPayload</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li></ul><h3 id=전체-흐름>전체 흐름<a hidden class=anchor aria-hidden=true href=#전체-흐름>#</a></h3><p><img loading=lazy src=../msa-stack-quick-peek/9.png alt=messaging-sequence.png></p><h2 id=6-cicd>6. CI/CD<a hidden class=anchor aria-hidden=true href=#6-cicd>#</a></h2><h3 id=cicd란>CI/CD란<a hidden class=anchor aria-hidden=true href=#cicd란>#</a></h3><ul><li>CI (Continuous Integration): 애플리케이션의 소스 변경 사항이 지속적으로 빌드 및 테스트되어 공유 리포지토리에 통합되는 것이다.</li><li>CD (Continuous Delivery/Deployment): 변경 사항을 테스트 또는 프로덕션 환경에 지속적으로 배포하는 것이다.</li></ul><h3 id=jenkinsfile>Jenkinsfile<a hidden class=anchor aria-hidden=true href=#jenkinsfile>#</a></h3><ul><li><p>jenkins는 CI 도구이다.</p><ul><li>빌드 → 테스트 → 코드 분석 → 도커 이미지 빌드 → helm chart 빌드</li><li>위 과정을 파이프라인으로 자동화 해준다.</li></ul></li><li><p>파이프라인은 Job들을 순차적 또는 병렬적으로 실행시키거나 작성한 스크립드로 이벤트를 연속적으로 실행시키는 것이다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>@<span style=color:#ae81ff>Library(&#39;meshkorea&#39;) _</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>vroongNeoMsaJavaPipeline(</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>team</span>: <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>ecrRepoName</span>: <span style=color:#e6db74>&#39;vroong/msabootcamp&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>argoAppName</span>: <span style=color:#e6db74>&#39;vroong-msabootcamp&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>gradleBuildArguments</span>: <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>)</span>
</span></span></code></pre></div><ul><li>team: 슬랙 {team}-build-alerts 채널에 관련 alert를 발생시킨다.</li><li>ecrRepoName: Jenkins에서 도커 빌드 후 push할 ECR 이름</li><li>argoAppName: argoCD 앱 이름</li><li>gradleBuildArguments: jar 파일 빌드시 뒤에 추가할 argument</li></ul></li><li><p>Jenkins 파이프라인 적용 방법</p><ul><li>리포지토리 root에 Jenkinsfile이 있어야만 파이프라인이 실행된다.</li><li>github push, PR, merge 와 같은 이벤트 발생시 파이프라인이 구동된다.</li><li>도커 이미지 tag는 파이프라인에 도커 빌드 과정에서 {tag}-{commit hash} 형태로 빌드 후 ECR에 push된다.<ul><li>tag가 example이고, commit hash가 2d48cj3a인 경우 도커 이미지 tag는 example-2d48cj3a이다.</li></ul></li></ul></li></ul><h3 id=helm-values>Helm values<a hidden class=anchor aria-hidden=true href=#helm-values>#</a></h3><ul><li>Helm은 K8S 패키지 관리를 도와주는 패키지 매니저이다.<ul><li>ex) dev와 qa, prod 환경의 DB 주소가 다르다면 이를 관리해 주는 것이다.</li></ul></li><li>vroong-{appname}-helm-values 리포지토리 에 필요한 환경 변수 추가<ul><li>위 리포지토리를 보면 다음과 같은 구조가 있다.<ul><li>dev1</li><li>prod</li><li>qa1 ~ 4</li><li>values.yaml</li></ul></li><li>argoCD에서 helm values를 배포하면 K8S 서비스, deployment(replica set, pod), 서비스 account, config map 등의 리소스를 만들어준다.</li></ul></li><li>values.yaml<ul><li>모든 환경에 동일하게 적용되어야 하는 내용이 선언되어 있다.</li><li>각 환경 별로 values.yaml 파일이 또 있다.<ul><li>각 환경 별로 바인딩 되어야 하는 환경 변수를 선언한다.</li><li>override하고 싶은 내용을 선언한다.</li></ul></li></ul></li></ul><h3 id=빌드-및-배포-과정>빌드 및 배포 과정<a hidden class=anchor aria-hidden=true href=#빌드-및-배포-과정>#</a></h3><p><img loading=lazy src=../msa-stack-quick-peek/10.png alt=10></p><ol><li>Start</li><li>Init<ul><li>저장소 checkout 후, commit hash를 구한다.</li><li>슬랙에 파이프라인 구동 메세지를 보낸다.</li><li>Jenkinsfile에 작성한 값을 읽어낸다.</li></ul></li><li>Check the docker image<ul><li>ECR에 같은 tag를 가진 이미지가 있는지 확인한다.</li></ul></li><li>Gradle build<ul><li>nexus에 접근하기 위한 계정 정보를 복사한다.</li><li>jar 파일을 빌드한다.</li></ul></li><li>code review / unit test<ul><li>sonarqube로 코드 리뷰를 하고 unit 테스트를 수행한다.</li></ul></li><li>Docker / ECR login<ul><li>도커 이미지를 빌드하고 tag를 붙인다.</li><li>ECR에 login한다.</li></ul></li><li>ECR push<ul><li>ECR에 도커 이미지를 push한다.</li></ul></li><li>ArgoCD trigger<ul><li>argoCD에 login한다.</li><li>슬랙에 빌드 완료 메세지를 보낸다.</li></ul></li><li>End</li></ol><p><img loading=lazy src=../msa-stack-quick-peek/11.png alt=11></p><ol><li><p>Jenkins 과정을 거친 후 APP DIFF 버튼을 눌러, helm values 변경 사항을 확인한다.</p></li><li><p>변경 사항에 이상이 없으면 SYNC 버튼을 누른다.</p></li><li><p>pod가 잘 교체 되는지 확인한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>k9s
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/<span style=color:#f92672>{</span>서비스 이름으로 검색<span style=color:#f92672>}</span>
</span></span></code></pre></div><p><img loading=lazy src=../msa-stack-quick-peek/12.png alt=12></p><ul><li>상단 Context에서 현재 환경을 확인할 수 있다.</li><li>새로운 pod가 실행된 후 완료되면 기존 pod를 교체한다.</li></ul></li><li><p>모니터링한다.</p></li></ol><h2 id=7-uaa>7. UAA<a hidden class=anchor aria-hidden=true href=#7-uaa>#</a></h2><ul><li><p>User Account and Authentication</p></li><li><p>MSA Resource 서버를 보호하기 위한 Authorization Server</p></li><li><p>OAuth2 (Open Authorization) 방식</p><ul><li>Authorization Code Grant Type</li><li>Resource Owner Password Grant type</li><li>Client Credentials Grant Type</li></ul></li><li><p>Client Credentials Grant Type Flow
<a href="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FAGn3b%2FbtqVyURyeZN%2F77J24Xr2Y3aAIZyLUsQZg1%2Fimg.png">https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FAGn3b%2FbtqVyURyeZN%2F77J24Xr2Y3aAIZyLUsQZg1%2Fimg.png</a></p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>security</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>oauth2</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>client</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>access-token-uri</span>: <span style=color:#ae81ff>http://localhost:9999/oauth/token</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>user-authorization-uri</span>: <span style=color:#ae81ff>http://localhost:9999/oauth/token</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client-id</span>: <span style=color:#ae81ff>internal</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client-secret</span>: <span style=color:#ae81ff>internal</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>scope</span>: <span style=color:#ae81ff>web-app</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>grant-type</span>: <span style=color:#ae81ff>client_credentials</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>authorized-grant-type</span>: <span style=color:#ae81ff>password, client_credentials, refresh_token</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>resource</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>jwt.key-uri</span>: <span style=color:#ae81ff>http://localhost:9999/oauth/token_key</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://jo-minjun.github.io/tags/msa/>MSA</a></li><li><a href=https://jo-minjun.github.io/tags/api-first/>API-First</a></li><li><a href=https://jo-minjun.github.io/tags/ci/cd/>CI/CD</a></li><li><a href=https://jo-minjun.github.io/tags/message-queue/>Message-Queue</a></li></ul><nav class=paginav><a class=next href=https://jo-minjun.github.io/notes/ddd-study/><span class=title>Next »</span><br><span>DDD 핵심 정리</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share MSA 개발 스택 빠르게 훑어보기 on twitter" href="https://twitter.com/intent/tweet/?text=MSA%20%ea%b0%9c%eb%b0%9c%20%ec%8a%a4%ed%83%9d%20%eb%b9%a0%eb%a5%b4%ea%b2%8c%20%ed%9b%91%ec%96%b4%eb%b3%b4%ea%b8%b0&amp;url=https%3a%2f%2fjo-minjun.github.io%2fnotes%2fmsa-stack-quick-peek%2f&amp;hashtags=MSA%2cAPI-First%2cCI%2fCD%2cMessage-Queue"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share MSA 개발 스택 빠르게 훑어보기 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fjo-minjun.github.io%2fnotes%2fmsa-stack-quick-peek%2f&amp;title=MSA%20%ea%b0%9c%eb%b0%9c%20%ec%8a%a4%ed%83%9d%20%eb%b9%a0%eb%a5%b4%ea%b2%8c%20%ed%9b%91%ec%96%b4%eb%b3%b4%ea%b8%b0&amp;summary=MSA%20%ea%b0%9c%eb%b0%9c%20%ec%8a%a4%ed%83%9d%20%eb%b9%a0%eb%a5%b4%ea%b2%8c%20%ed%9b%91%ec%96%b4%eb%b3%b4%ea%b8%b0&amp;source=https%3a%2f%2fjo-minjun.github.io%2fnotes%2fmsa-stack-quick-peek%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share MSA 개발 스택 빠르게 훑어보기 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fjo-minjun.github.io%2fnotes%2fmsa-stack-quick-peek%2f&title=MSA%20%ea%b0%9c%eb%b0%9c%20%ec%8a%a4%ed%83%9d%20%eb%b9%a0%eb%a5%b4%ea%b2%8c%20%ed%9b%91%ec%96%b4%eb%b3%b4%ea%b8%b0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share MSA 개발 스택 빠르게 훑어보기 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjo-minjun.github.io%2fnotes%2fmsa-stack-quick-peek%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share MSA 개발 스택 빠르게 훑어보기 on whatsapp" href="https://api.whatsapp.com/send?text=MSA%20%ea%b0%9c%eb%b0%9c%20%ec%8a%a4%ed%83%9d%20%eb%b9%a0%eb%a5%b4%ea%b2%8c%20%ed%9b%91%ec%96%b4%eb%b3%b4%ea%b8%b0%20-%20https%3a%2f%2fjo-minjun.github.io%2fnotes%2fmsa-stack-quick-peek%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share MSA 개발 스택 빠르게 훑어보기 on telegram" href="https://telegram.me/share/url?text=MSA%20%ea%b0%9c%eb%b0%9c%20%ec%8a%a4%ed%83%9d%20%eb%b9%a0%eb%a5%b4%ea%b2%8c%20%ed%9b%91%ec%96%b4%eb%b3%b4%ea%b8%b0&amp;url=https%3a%2f%2fjo-minjun.github.io%2fnotes%2fmsa-stack-quick-peek%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><div><script src=https://utteranc.es/client.js repo=jo-minjun/my-blog issue-term=pathname label=comment theme=photon-dark crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://jo-minjun.github.io>minjun's memory</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>