<!doctype html><html lang=kr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="jo-minjun"><meta name=description content="DDD 스터디 공유 0. 참고 도메인 주도 개발 시작하기
도메인 주도 개발 시작하기 - YES24 핵사고날 아키텍처
Hexagonal Architecture with Java and Spring
https://herbertograca.com/2017/11/16/explicit-architecture-01-ddd-hexagonal-onion-clean-cqrs-how-i-put-it-all-together/
예제 프로젝트
https://github.com/jo-minjun/order-delivery-project 1. 도메인이란 무엇일까? wikipedia: Domain (software engineering) A domain is the targeted subject area of a computer program. It is a term used in software engineering. Formally it represents the target subject of a specific programming project, whether narrowly or broadly defined."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="DDD 스터디 공유"><meta name=twitter:description content="DDD 스터디 공유 0. 참고 도메인 주도 개발 시작하기
도메인 주도 개발 시작하기 - YES24 핵사고날 아키텍처
Hexagonal Architecture with Java and Spring
https://herbertograca.com/2017/11/16/explicit-architecture-01-ddd-hexagonal-onion-clean-cqrs-how-i-put-it-all-together/
예제 프로젝트
https://github.com/jo-minjun/order-delivery-project 1. 도메인이란 무엇일까? wikipedia: Domain (software engineering) A domain is the targeted subject area of a computer program. It is a term used in software engineering. Formally it represents the target subject of a specific programming project, whether narrowly or broadly defined."><meta property="og:title" content="DDD 스터디 공유"><meta property="og:description" content="DDD 스터디 공유 0. 참고 도메인 주도 개발 시작하기
도메인 주도 개발 시작하기 - YES24 핵사고날 아키텍처
Hexagonal Architecture with Java and Spring
https://herbertograca.com/2017/11/16/explicit-architecture-01-ddd-hexagonal-onion-clean-cqrs-how-i-put-it-all-together/
예제 프로젝트
https://github.com/jo-minjun/order-delivery-project 1. 도메인이란 무엇일까? wikipedia: Domain (software engineering) A domain is the targeted subject area of a computer program. It is a term used in software engineering. Formally it represents the target subject of a specific programming project, whether narrowly or broadly defined."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.minjun.pe/posts/ddd-study-share/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-06T01:13:45+09:00"><meta property="article:modified_time" content="2022-08-06T01:13:45+09:00"><title>Hello Hugo</title><link rel=canonical href=http://blog.minjun.pe/posts/ddd-study-share/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.6b1a4fbc48955b72aea7913e43fabeb45e8bc120da5aa41b598dd33adcac4b59.css integrity="sha256-axpPvEiVW3Kup5E+Q/q+tF6LwSDaWqQbWY3TOtysS1k=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.101.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Hello Hugo</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Post</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://blog.minjun.pe/posts/ddd-study-share/>DDD 스터디 공유</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-08-06T01:13:45+09:00>August 6, 2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i></span></div><div class=authors><i class="fa fa-user" aria-hidden=true></i>
<a href=/authors/%EC%A1%B0%EB%AF%BC%EC%A4%80/>조민준</a></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/design/architecture/>Design/Architecture</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/ddd/>DDD</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/hexagonal-architecture/>Hexagonal Architecture</a></span></div></div></header><div><h1 id=ddd-스터디-공유>DDD 스터디 공유
<a class=heading-link href=#ddd-%ec%8a%a4%ed%84%b0%eb%94%94-%ea%b3%b5%ec%9c%a0><i class="fa fa-link" aria-hidden=true></i></a></h1><h2 id=0-참고>0. 참고
<a class=heading-link href=#0-%ec%b0%b8%ea%b3%a0><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li><p>도메인 주도 개발 시작하기</p><ul><li><a href=http://www.yes24.com/Product/Goods/108431347>도메인 주도 개발 시작하기 - YES24</a></li></ul></li><li><p>핵사고날 아키텍처</p><ul><li><p><a href=https://reflectoring.io/spring-hexagonal/>Hexagonal Architecture with Java and Spring</a></p></li><li><p><a href=https://herbertograca.com/2017/11/16/explicit-architecture-01-ddd-hexagonal-onion-clean-cqrs-how-i-put-it-all-together/>https://herbertograca.com/2017/11/16/explicit-architecture-01-ddd-hexagonal-onion-clean-cqrs-how-i-put-it-all-together/</a></p></li></ul></li><li><p>예제 프로젝트</p><ul><li><a href=https://github.com/jo-minjun/order-delivery-project>https://github.com/jo-minjun/order-delivery-project</a></li></ul></li></ul><h2 id=1-도메인이란-무엇일까>1. 도메인이란 무엇일까?
<a class=heading-link href=#1-%eb%8f%84%eb%a9%94%ec%9d%b8%ec%9d%b4%eb%9e%80-%eb%ac%b4%ec%97%87%ec%9d%bc%ea%b9%8c><i class="fa fa-link" aria-hidden=true></i></a></h2><h3 id=wikipedia-domain-software-engineering>wikipedia: Domain (software engineering)
<a class=heading-link href=#wikipedia-domain-software-engineering><i class="fa fa-link" aria-hidden=true></i></a></h3><blockquote><p>A domain is the targeted subject area of a <a href=https://en.wikipedia.org/wiki/Computer_program>computer program</a>. It is a term used in <a href=https://en.wikipedia.org/wiki/Software_engineering>software engineering</a>.
Formally it represents the target subject of a specific programming project, whether narrowly or broadly defined.</p></blockquote><ol><li>소프트웨어 엔지니어링에서 사용되는 용어</li><li>컴퓨터 프로그램의 대상이 되는 영역</li></ol><h3 id=example>Example
<a class=heading-link href=#example><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>소프트웨어 프로젝트의 목표가 특정 병원을 위한 프로그램을 만드는 경우</li><li>범위를 확장하여 모든 병원을 대상으로 하는 프로그램을 만드는 경우</li><li>상점과 기사를 이어주고 고객에게 물품을 전달해주는 라스트마일 서비스</li></ul><h2 id=2-ddd란-무엇일까>2. DDD란 무엇일까?
<a class=heading-link href=#2-ddd%eb%9e%80-%eb%ac%b4%ec%97%87%ec%9d%bc%ea%b9%8c><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>Domain Driven Design이다.</li><li>프로그램을 도메인별로 나누어 설계하는 방법</li><li>모듈(도메인)간 응집도는 높이고, 결합도는 낮춰 준다.</li><li>DDD의 목표를 달성하기 위해 전략적 설계 패턴과 전술적 설계 패턴을 사용한다.</li></ul><h2 id=3-왜-ddd를-할까>3. 왜 DDD를 할까?
<a class=heading-link href=#3-%ec%99%9c-ddd%eb%a5%bc-%ed%95%a0%ea%b9%8c><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>복잡도 관리<ul><li>시간 경과에 따라 코드 라인이 늘어나고, 변경 비용이 증가한다.
<img src=https://dreamix.eu/blog/wp-content/uploads/2020/08/blogAcho2.png alt=https://dreamix.eu/blog/java/why-good-clean-software-architecture-matters>
<a href=https://dreamix.eu/blog/java/why-good-clean-software-architecture-matters>https://dreamix.eu/blog/java/why-good-clean-software-architecture-matters</a></li></ul></li><li>개발자는 특정 도메인의 전문가보다 도메인에 대한 전문성이 떨어진다.<ul><li>공인 중개사와 개발자</li><li>변호사와 개발자</li><li>인사팀과 개발자</li><li>…</li></ul></li><li>전문가와 기획자, 개발자의 언어가 다르다.<ul><li>도저히 이해할 수 없는 말들…</li><li>네트워크 광전송 장비: OTN, PTN, ROADM, SERVICE, TUNNEL…</li></ul></li></ul><p>→ 최소 문서를 읽거나 대화할 때 서로가 하는 말을 이해하고 context를 맞춰 나가야 한다.</p><h2 id=4-전략적-설계>4. 전략적 설계
<a class=heading-link href=#4-%ec%a0%84%eb%9e%b5%ec%a0%81-%ec%84%a4%ea%b3%84><i class="fa fa-link" aria-hidden=true></i></a></h2><h3 id=유비쿼터스-언어>유비쿼터스 언어
<a class=heading-link href=#%ec%9c%a0%eb%b9%84%ec%bf%bc%ed%84%b0%ec%8a%a4-%ec%96%b8%ec%96%b4><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>도메인 전문가, 기획자, 개발자 등 구성원들이 서로 다른 용어를 사용하면, 의사소통에 불편함이 있다.<ul><li>지번주소 vs 구주소</li></ul></li></ul><p>→ <strong>유비쿼터스 언어</strong>를 사용해야 한다.</p><ul><li>구성원들 모두가 <strong>보편적으로 사용하는 언어</strong></li><li>구성원들의 공통된 언어를 만들고 대화, 문서, 코드, 테스트 <strong>모든 곳에서 같은 용어</strong>를 사용한다.</li></ul><h3 id=도메인-모델과-경계>도메인 모델과 경계
<a class=heading-link href=#%eb%8f%84%eb%a9%94%ec%9d%b8-%eb%aa%a8%eb%8d%b8%ea%b3%bc-%ea%b2%bd%ea%b3%84><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>다시 도메인에 대해 짚어보자면<ul><li>소프트웨어 프로젝트에서 대상이 되고, 해결해야 할 영역</li><li>온라인 쇼핑몰을 개발하는 프로젝트</li></ul></li><li>도메인은 다시 하위 도메인으로 나뉘어 진다.<ul><li>회원, 혜택(쿠폰), 주문, 카탈로그, 배송, 결제…</li></ul></li><li><strong>도메인 모델</strong><ul><li>특정 도메인을 개념적으로 표현한 것</li><li>도메인에 대한 이해도에 따라 도메인 모델도 변경된다.
<img src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/5fe98397-c546-457c-8961-909aab4bde0c/1.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20220805%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20220805T161805Z&X-Amz-Expires=86400&X-Amz-Signature=24aa49b571b9900c4e02b65ec715bac96de0666c46dc80b86765fd91722b7b87&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%221.png%22&x-id=GetObject" alt="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/5fe98397-c546-457c-8961-909aab4bde0c/1.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20220805%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20220805T161805Z&X-Amz-Expires=86400&X-Amz-Signature=24aa49b571b9900c4e02b65ec715bac96de0666c46dc80b86765fd91722b7b87&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%221.png%22&x-id=GetObject"></li></ul></li><li>위와 같은 서브 도메인을 하나의 도메인으로 표현하기는 불가능에 가깝다.</li><li>서브 도메인마다 같은 대상이라도 지칭하는 용어가 다를 수 있다.</li></ul><p>→ Problem Space가 된다.</p><ul><li>상품<ul><li>카탈로그의 상품: 이미지, 상품명, 가격…</li><li>배송의 상품: 무게, 수량…</li></ul></li><li>회원<ul><li>회원 도메인의 회원: 회원</li><li>주문 도메인의 회원: 주문자</li><li>배송 도메인의 회원: 받는 사람</li></ul></li><li>즉, 모델은 특정한 컨텍스트 하에서 완전한 의미를 갖는다.</li></ul><p>→ 각 서브 도메인마다 <strong>명시적으로 구분되는 경계</strong>를 가져서 섞이지 않도록 해야 한다.</p><h3 id=바운디드-컨텍스트>바운디드 컨텍스트
<a class=heading-link href=#%eb%b0%94%ec%9a%b4%eb%94%94%eb%93%9c-%ec%bb%a8%ed%85%8d%ec%8a%a4%ed%8a%b8><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>각 도메인 영역의 경계를 결정하는 <strong>명시적인 구분</strong></li><li>각각의 도메인이 가진 모델을 정확하게 표현하기 위함이다.</li></ul><p>→ 즉 문제를 해결하기 위한 공간, Solution Space이다.</p><ul><li>바운디드 컨텍스트를 구분하는 조건<ul><li>같은 용어, 다른 의미<ul><li><strong>계정</strong>을 의미하는 Account</li><li><strong>계좌</strong>를 의미하는 Account
→ 이런 경우 두 가지 의미를 하나의 도메인 모델에 포함해서는 안된다.</li></ul></li><li>같은 개념, 다른 용도<ul><li>회원 서비스의 <strong>맴버</strong></li><li>주문 서비스의 <strong>맴버</strong>
→ 맴버는 서로 다른 도메인에 집중하고 있고, 발전의 방향성도 다르다.</li></ul></li><li>팀 조직 구조<ul><li>A팀의 관심사는 주문, B팀의 관심사는 결제.<ul><li>하나의 주문 도메인에서도 관심사에 따라 컨텍스트가 달라진다.</li></ul></li><li>한 팀이 하나의 시스템에서 온라인 쇼핑을 서비스한다.<ul><li>서브 도메인은 회원, 카탈로그, 재고, 구매, 결제 등이 있다.</li><li>상품 컨텍스트에서 재고와 카탈로그를 구현한다.</li></ul></li></ul></li></ul></li><li>이상적으로는 바운디드 컨텍스트와 하위 도메인이 1대1로 대응되는 것이 좋다.</li><li>하지만 팀 상황이나 유비쿼터스 언어가 명확하게 정의되지 않아 1대1로 대응되지 않는 경우도 있다.
<img src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/51c2c84d-2c5e-4707-a7d6-911fb550b8b1/40.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20220805%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20220805T161824Z&X-Amz-Expires=86400&X-Amz-Signature=b45a88b6ef46b4178703cc9985c8330c6a2bd47d3c2ed08aa19ed465c29e97d0&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%2240.png%22&x-id=GetObject" alt="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/51c2c84d-2c5e-4707-a7d6-911fb550b8b1/40.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20220805%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20220805T161824Z&X-Amz-Expires=86400&X-Amz-Signature=b45a88b6ef46b4178703cc9985c8330c6a2bd47d3c2ed08aa19ed465c29e97d0&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%2240.png%22&x-id=GetObject"></li></ul><h3 id=바운디드-컨텍스트-간-관계>바운디드 컨텍스트 간 관계
<a class=heading-link href=#%eb%b0%94%ec%9a%b4%eb%94%94%eb%93%9c-%ec%bb%a8%ed%85%8d%ec%8a%a4%ed%8a%b8-%ea%b0%84-%ea%b4%80%ea%b3%84><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>바운디드 컨텍스트는 어떻게든 연결되기 때문에 다양한 방식으로 관계를 형성한다.<ul><li>고객/공급자</li><li>공유 커널</li><li>독립 방식</li></ul></li><li><strong>고객/공급자</strong><ul><li>가장 흔한 관계이다.</li><li>한쪽에서 **API를 제공(상류)**하고 다른쪽에서 **API를 호출(하류)**한다.
<img src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/8f9c8822-1071-4053-b528-8d4eb23a062f/54.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20220804%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20220804T141841Z&X-Amz-Expires=86400&X-Amz-Signature=14cf7c755024975f777ad1c80685679e8d2f24c7eeb5a01141c79e0bca14f63a&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%2254.png%22&x-id=GetObject" alt="카탈로그 바운디드 컨텍스트는 추천 바운디드 컨텍스트에 의존한다.">
카탈로그 바운디드 컨텍스트는 추천 바운디드 컨텍스트에 의존한다.</li></ul></li><li><strong>공유 커널</strong><ul><li>여러 바운디드 컨텍스트가 <strong>같은 모델을 공유</strong>하는 관계이다.</li><li>중복을 줄일 수 있지만 공유 모델을 사용하는 바운디드 컨텍스트가 서로 영향을 받을 수 있다.</li></ul></li><li><strong>독립 방식</strong><ul><li>여러 바운디드 컨텍스트가 <strong>외부에 의해 관계</strong>를 맺는다.<ul><li>수동으로 두 바운디드 컨텍스트 간 통합시킨다.<ul><li>사람에 의한 관계</li></ul></li><li>자동화 시스템을 개발해서 두 바운디드 컨텍스트를 통합시킨다.<ul><li>자동화 시스템에 의한 관계</li></ul></li></ul></li></ul></li></ul><h3 id=바운디드-컨텍스트-맵>바운디드 컨텍스트 맵
<a class=heading-link href=#%eb%b0%94%ec%9a%b4%eb%94%94%eb%93%9c-%ec%bb%a8%ed%85%8d%ec%8a%a4%ed%8a%b8-%eb%a7%b5><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>특정 바운디드 컨텍스트에 과도하게 집중하면 전체적인 바운디드 컨텍스트 간의 관계를 인식하지 못할 수 있다.</li><li>도메인을 더 잘 이해하거나 컨텍스트 간 관계가 바뀌면 컨텍스트 맵도 바뀐다.
<img src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/40deb960-9c9a-4129-a315-f7d4e1689f34/58.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20220805%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20220805T161847Z&X-Amz-Expires=86400&X-Amz-Signature=3464fbbc1457ffdd31c87ce23f7cc0de67b0bcf5a35192da02c641b3c10b6278&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%2258.png%22&x-id=GetObject" alt="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/40deb960-9c9a-4129-a315-f7d4e1689f34/58.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20220805%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20220805T161847Z&X-Amz-Expires=86400&X-Amz-Signature=3464fbbc1457ffdd31c87ce23f7cc0de67b0bcf5a35192da02c641b3c10b6278&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%2258.png%22&x-id=GetObject"></li></ul><h2 id=5-핵사고날-아키텍처>5. 핵사고날 아키텍처
<a class=heading-link href=#5-%ed%95%b5%ec%82%ac%ea%b3%a0%eb%82%a0-%ec%95%84%ed%82%a4%ed%85%8d%ec%b2%98><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>예제 프로젝트에 핵사고날 아키텍처를 적용했다.
<img src=https://reflectoring.io/images/posts/spring-hexagonal/hexagonal-architecture_hu6764515d7030d45af6f7f498c79e292b_50897_956x0_resize_box_3.png alt=https://reflectoring.io/spring-hexagonal/>
<a href=https://reflectoring.io/spring-hexagonal/>https://reflectoring.io/spring-hexagonal/</a></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span>└──</span> xxx
</span></span><span style=display:flex><span>    <span>├──</span> adapter
</span></span><span style=display:flex><span>    <span>│</span>   <span>├──</span> in
</span></span><span style=display:flex><span>    <span>│</span>   <span>│</span>   <span>├──</span> xxxController.java
</span></span><span style=display:flex><span>    <span>│</span>   <span>│</span>   <span>└──</span> EventHandler.java (or MessageHandler.java)
</span></span><span style=display:flex><span>    <span>│</span>   <span>└──</span> out
</span></span><span style=display:flex><span>    <span>│</span>       <span>└──</span> EventPublisher.java (or MessagePublisher.java)
</span></span><span style=display:flex><span>    <span>├──</span> application
</span></span><span style=display:flex><span>    <span>│</span>   <span>├──</span> xxxService.java
</span></span><span style=display:flex><span>    <span>│</span>   <span>└──</span> port
</span></span><span style=display:flex><span>    <span>│</span>       <span>├──</span> in
</span></span><span style=display:flex><span>    <span>│</span>       <span>│</span>   <span>├──</span> xxxCommand.java
</span></span><span style=display:flex><span>    <span>│</span>       <span>│</span>   <span>├──</span> xxxDto.java
</span></span><span style=display:flex><span>    <span>│</span>       <span>│</span>   <span>└──</span> xxxUsecase.java
</span></span><span style=display:flex><span>    <span>│</span>       <span>└──</span> out
</span></span><span style=display:flex><span>    <span>│</span>           <span>├──</span> xxxEvent.java
</span></span><span style=display:flex><span>    <span>│</span>           <span>├──</span> xxxEventPublisher.java
</span></span><span style=display:flex><span>    <span>│</span>           <span>└──</span> xxxRepository.java
</span></span><span style=display:flex><span>    <span>└──</span> domain
</span></span><span style=display:flex><span>        <span>├──</span> AggregateRootEntity.java
</span></span><span style=display:flex><span>        <span>└──</span> ValueObject.java
</span></span></code></pre></div><h2 id=6-전술적-설계>6. 전술적 설계
<a class=heading-link href=#6-%ec%a0%84%ec%88%a0%ec%a0%81-%ec%84%a4%ea%b3%84><i class="fa fa-link" aria-hidden=true></i></a></h2><h3 id=도메인-영역의-주요-구성-요소>도메인 영역의 주요 구성 요소
<a class=heading-link href=#%eb%8f%84%eb%a9%94%ec%9d%b8-%ec%98%81%ec%97%ad%ec%9d%98-%ec%a3%bc%ec%9a%94-%ea%b5%ac%ec%84%b1-%ec%9a%94%ec%86%8c><i class="fa fa-link" aria-hidden=true></i></a></h3><table><thead><tr><th>요소</th><th>설명</th></tr></thead><tbody><tr><td>엔티티ENTITY</td><td>고유의 식별자를 갖는 객체로 자신의 라이프 사이클을 갖는다.도메인의 고유한 개념을 표현한다.도메인 모델의 데이터를 포함하며 해당 데이터와 관련된 기능을 함께 제공한다.</td></tr><tr><td>밸류VALUE</td><td>고유의 식별자를 갖지 않는 객체다.엔티티의 속성으로 사용할 뿐만 아니라 다른 밸류 타입의 속성으로도 사용할 수 있다.</td></tr><tr><td>애그리거트AGGREGATE</td><td>애그리거트는 연관된 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것이다.</td></tr><tr><td>리포지터리REPOSITORY</td><td>도메인 모델의 영속성을 처리한다.</td></tr><tr><td>도메인 서비스DOMAIN SERVICE</td><td>특정 엔티티에 속하지 않은 도메인 로직을 제공한다.도메인 로직이 여러 엔티티와 밸류를 필요로 하면 도메인 서비스에서 로직을 구현한다.</td></tr></tbody></table><h3 id=엔티티--밸류>엔티티 & 밸류
<a class=heading-link href=#%ec%97%94%ed%8b%b0%ed%8b%b0--%eb%b0%b8%eb%a5%98><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li><p>도메인 모델을 표현할 때 이용한다.</p></li><li><p>도메인 모델의 엔티티는 기능을 함께 제공한다.</p><ul><li>도메인 관점에서 도메인 로직을 구현하고 캡슐화해서 데이터가 임의로 변경되는 것을 막는다.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.delivery.domain</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>public</span> <span>void</span> changeDeliveryInfo(Address address, String phoneNumber) {
</span></span><span style=display:flex><span>  canChangeDelivery();
</span></span><span style=display:flex><span>  <span style=font-weight:700>this</span>.address = address;
</span></span><span style=display:flex><span>  <span style=font-weight:700>this</span>.phoneNumber = phoneNumber;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>private</span> <span>void</span> canChangeDelivery() {
</span></span><span style=display:flex><span>  <span style=font-weight:700>if</span> (!<span style=font-weight:700>this</span>.status.canChangeDelivery()) {
</span></span><span style=display:flex><span>    <span style=font-weight:700>throw</span> <span style=font-weight:700>new</span> RuntimeException(<span style=font-style:italic>&#34;배송 정보 수정 불가&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>외부에서 setter를 이용해 배송지 정보를 변경한다면 배송지 변경 가능 여부 검증이 누락될 수 있고, 같은 로직이 반복될 수도 있다.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>final</span> DeliveryStatus status = delivery.getStatus();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-style:italic>// 배송지 변경 조건
</span></span></span><span style=display:flex><span><span style=font-style:italic></span><span style=font-weight:700>if</span> (!<span style=font-weight:700>this</span>.status.canChangeDelivery()) {
</span></span><span style=display:flex><span>  <span style=font-weight:700>throw</span> <span style=font-weight:700>new</span> RuntimeException(<span style=font-style:italic>&#34;배송 정보 수정 불가&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>delivery.setAddress(newAddress);
</span></span><span style=display:flex><span>delivery.setPhoneNumber(newPhoneNumber);
</span></span></code></pre></div></li><li><p>밸류는 도메인 모델에서 두 개 이상의 데이터가 개념적으로 하나인 경우 사용한다.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.order.domain</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Entity
</span></span><span style=display:flex><span>@Table(name = <span style=font-style:italic>&#34;orders&#34;</span>)
</span></span><span style=display:flex><span>@Getter
</span></span><span style=display:flex><span>@NoArgsConstructor(access = AccessLevel.PROTECTED)
</span></span><span style=display:flex><span>@AllArgsConstructor
</span></span><span style=display:flex><span>@EqualsAndHashCode(of = {<span style=font-style:italic>&#34;id&#34;</span>})
</span></span><span style=display:flex><span>@ToString(of = {<span style=font-style:italic>&#34;id&#34;</span>, <span style=font-style:italic>&#34;orderLine&#34;</span>, <span style=font-style:italic>&#34;totalAmount&#34;</span>, <span style=font-style:italic>&#34;deliveryId&#34;</span>, <span style=font-style:italic>&#34;paymentId&#34;</span>})
</span></span><span style=display:flex><span><span style=font-weight:700>public</span> <span style=font-weight:700>class</span> <span style=font-weight:700>Order</span> <span style=font-weight:700>implements</span> Serializable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  @Id
</span></span><span style=display:flex><span>  @GeneratedValue(strategy = GenerationType.IDENTITY)
</span></span><span style=display:flex><span>  <span style=font-weight:700>private</span> Long id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  @Embedded
</span></span><span style=display:flex><span>  <span style=font-weight:700>private</span> OrderLine orderLine;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-style:italic>// 밸류 타입, AttributeConverter를 이용함.
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>  <span style=font-weight:700>private</span> Money totalAmount = Money.ZERO;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	... <span style=font-style:italic>// 다른 필드
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.common</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Converter(autoApply = <span style=font-weight:700>true</span>)
</span></span><span style=display:flex><span><span style=font-weight:700>public</span> <span style=font-weight:700>class</span> <span style=font-weight:700>MoneyConverter</span> <span style=font-weight:700>implements</span> AttributeConverter&lt;Money, BigDecimal&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  @Override
</span></span><span style=display:flex><span>  <span style=font-weight:700>public</span> BigDecimal convertToDatabaseColumn(Money attribute) {
</span></span><span style=display:flex><span>    <span style=font-weight:700>return</span> attribute.getValue();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  @Override
</span></span><span style=display:flex><span>  <span style=font-weight:700>public</span> Money convertToEntityAttribute(BigDecimal dbData) {
</span></span><span style=display:flex><span>    <span style=font-weight:700>return</span> <span style=font-weight:700>new</span> Money(dbData);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>엔티티는 @Entity 애너테이션을 사용한다.</p></li><li><p>밸류는 @Embeddable, @Embedded, @SecondaryTable, @ElementCollection, @CollectionTable을 사용한다.</p><ul><li>@ElementCollection은 생명주기를 상위 엔티티에 종속시킨다.</li><li>즉, cascade와 orphanRemoval 옵션을 제공하지 않는다.</li><li>@OneToMany(cascade = ALL, orphanRemoval = true)와 차이점<ul><li>@ElementCollection은 식별자를 갖지 않는다.</li></ul></li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.order.domain</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Embedded
</span></span><span style=display:flex><span><span style=font-weight:700>private</span> OrderLine orderLine;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.order.domain</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Embeddable
</span></span><span style=display:flex><span><span style=font-weight:700>public</span> <span style=font-weight:700>class</span> <span style=font-weight:700>OrderLine</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  @ElementCollection
</span></span><span style=display:flex><span>  @CollectionTable(name = <span style=font-style:italic>&#34;order_lines&#34;</span>, joinColumns = @JoinColumn(name = <span style=font-style:italic>&#34;orders_id&#34;</span>))
</span></span><span style=display:flex><span>  <span style=font-weight:700>private</span> Set&lt;LineItem&gt; lineItems = <span style=font-weight:700>new</span> HashSet&lt;&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ... <span style=font-style:italic>// 메서드
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>}
</span></span></code></pre></div><ul><li>@AttributeOverride를 이용해서 @Embeddable 밸류의 애트리뷰트를 override할 수도 있다.</li></ul><h3 id=애그리거트>애그리거트
<a class=heading-link href=#%ec%95%a0%ea%b7%b8%eb%a6%ac%ea%b1%b0%ed%8a%b8><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li><p>도메인이 커지면 도메인 모델이 복잡해진다.</p></li><li><p>도메인 모델이 복잡해지면 전체 구조에 초점을 맞추지 못하게 되고, 모델 간에 관계를 이해하기 어렵게 된다.</p></li><li><p>애그리거트는 관련 객체를 묶어서 <strong>상위 개념으로 표현</strong>해준다.</p><ul><li>Order 도메인은 주문, 주문 목록, 총 결제 금액 등 하위 모델로 구성된다.</li><li>이를 하나로 묶어 <strong>주문</strong>이라는 상위 개념으로 표현해준다.</li></ul></li><li><p>애그리거트는 루트 엔티티를 가지며, 이를 애그리거트 루트라 한다.</p></li><li><p>애그리거트 루트는 애그리거트에 속해 있는 엔티티와 밸류 객체를 이용해서 애그리거트가 구현해야 할 기능을 제공한다.</p><ul><li>애그리거트의 내부 구현을 숨겨서 애그리거트 단위로 구현을 캡슐화 한다.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.delivery.domain</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Entity
</span></span><span style=display:flex><span>... <span style=font-style:italic>// 애너테이션
</span></span></span><span style=display:flex><span><span style=font-style:italic></span><span style=font-weight:700>public</span> <span style=font-weight:700>class</span> <span style=font-weight:700>Delivery</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	@Id
</span></span><span style=display:flex><span>  @GeneratedValue(strategy = GenerationType.IDENTITY)
</span></span><span style=display:flex><span>  <span style=font-weight:700>private</span> Long id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	@Embedded
</span></span><span style=display:flex><span>  <span style=font-weight:700>private</span> Address address;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700>private</span> String phoneNumber;
</span></span><span style=display:flex><span>	... <span style=font-style:italic>// 다른 필드
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>
</span></span><span style=display:flex><span>	<span style=font-weight:700>public</span> <span>void</span> changeDeliveryInfo(Address address, String phoneNumber) {
</span></span><span style=display:flex><span>    canChangeDelivery();
</span></span><span style=display:flex><span>    <span style=font-weight:700>this</span>.address = address;
</span></span><span style=display:flex><span>    <span style=font-weight:700>this</span>.phoneNumber = phoneNumber;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div></li></ul><h3 id=리포지터리>리포지터리
<a class=heading-link href=#%eb%a6%ac%ed%8f%ac%ec%a7%80%ed%84%b0%eb%a6%ac><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>리포지터리는 애그리거트 단위로 도메인 객체를 저장하고 조회한다.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.order.application.port.out</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=font-weight:700>minjun.ddd.order.domain.Order</span>;
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=font-weight:700>org.springframework.data.jpa.repository.JpaRepository</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>public</span> <span style=font-weight:700>interface</span> <span style=font-weight:700>OrderRepository</span> <span style=font-weight:700>extends</span> JpaRepository&lt;Order, Long&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><p>애그리거트의 <strong>루트 엔티티만 리포지터리를 갖는다.</strong></p><ul><li>애그리거트의 밸류 등은 루트 엔티티와 생명 주기가 같다.</li><li><strong>생명 주기가 다르거나 데이터 변경 주체가 다르다면 다른 애그리거트일 가능성이 높다.</strong></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.product.application.port.out</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=font-weight:700>minjun.ddd.product.domain.Product</span>;
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=font-weight:700>org.springframework.data.jpa.repository.JpaRepository</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>public</span> <span style=font-weight:700>interface</span> <span style=font-weight:700>ProductRepository</span> <span style=font-weight:700>extends</span> JpaRepository&lt;Product, Long&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>Product 애그리거트는 Order나 Delivery와 연관이 있기 때문에 같은 애그리거트로 생각될 수 있다.</li><li>하지만 Order나 Delivery는 변경 주체가 주문자와 기사이지만, Product는 상품 관리자가 관리한다.</li></ul></li></ul><h3 id=도메인-서비스>도메인 서비스
<a class=heading-link href=#%eb%8f%84%eb%a9%94%ec%9d%b8-%ec%84%9c%eb%b9%84%ec%8a%a4><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li>도메인 영역을 개발하다 보면 <strong>한 애그리거트로 기능을 구현하지 못할 때</strong>가 있다.</li><li>결제 금액 계산 로직에 할인이 적용되는 경우<ul><li>할인 쿠폰 애그리거트: 쿠폰별로 지정한 금액이나 비율에 따라 총 금액을 할인한다.</li><li>회원 애그리거트: 회원 등급에 따라 추가 할인이 가능하다.</li></ul></li><li>주문 애그리거트에 할인 관련 로직을 적용하면 할인 정책 변경시 주문 애그리거트가 변경된다.</li></ul><p>→ <strong>도메인 서비스 사용</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>public</span> <span style=font-weight:700>class</span> <span style=font-weight:700>DiscountCalculationService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-weight:700>public</span> Money calculateDiscountAmounts(List&lt;OrderLine&gt; orderLines,
</span></span><span style=display:flex><span>																				List&lt;Coupon&gt; coupons,
</span></span><span style=display:flex><span>																				MemberGrade grade) {
</span></span><span style=display:flex><span>		Money couponDiscount = coupons.stream()
</span></span><span style=display:flex><span>												.map(coupon -&gt; calculateDiscount(coupon))
</span></span><span style=display:flex><span>												.reduce(<span style=font-weight:700>new</span> Money(0), (v1, v2) -&gt; v1.add(v2));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		Money membershipDiscount = calculateDiscount(orderer.getMember().getGrade());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=font-weight:700>return</span> couponDiscount.add(membershipDiscount);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-weight:700>private</span> Money calculateDiscount(Coupon coupon) {
</span></span><span style=display:flex><span>		...
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-weight:700>private</span> Money calculateDiscount(MemberGrade grade) {
</span></span><span style=display:flex><span>		...
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><p>외부 시스템이나 타 도메인과 <strong>연동 기능</strong>도 도메인 서비스가 될 수 있다.</p></li><li><p>상품 관리 시스템에서 사용자가 권한을 가졌는지 확인하기 위해 맴버 시스템을 연동하는 경우</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>public</span> <span style=font-weight:700>interface</span> <span style=font-weight:700>PermissionChecker</span> {
</span></span><span style=display:flex><span>	<span>boolean</span> hasUserPermission(String userId);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>여기서 인터페이스는 외부 시스템의 역할을 표현하기 위해 도메인 로직 관점에서 작성한다.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>public</span> <span style=font-weight:700>class</span> <span style=font-weight:700>CreateProductService</span> {
</span></span><span style=display:flex><span>	<span style=font-weight:700>private</span> PermissionChecker permissionChecker;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-weight:700>public</span> Long createProduct(CreateProductRequest req) {
</span></span><span style=display:flex><span>		validate(req);
</span></span><span style=display:flex><span>		<span style=font-weight:700>if</span> (!permissionChecker.hasUserPermission(req.getUserId)) {
</span></span><span style=display:flex><span>			<span style=font-weight:700>throw</span> <span style=font-weight:700>new</span> NoPermissionException();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		... <span style=font-style:italic>// 생성
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul><h3 id=이벤트>이벤트
<a class=heading-link href=#%ec%9d%b4%eb%b2%a4%ed%8a%b8><i class="fa fa-link" aria-hidden=true></i></a></h3><ul><li><p>API를 이용하는 방법은 <strong>시스템간 결합 문제</strong>를 발생시킨다.</p><ul><li>외부 서비스의 성능</li><li>트랜잭션 처리 정책</li><li>설계상 문제</li></ul></li><li><p><strong>외부 서비스의 성능</strong></p></li><li><p><strong>트랜잭션 처리 정책</strong></p><ol><li>환불 외부 서비스에서 익셉션이 발생하면 주문까지 트랜잭션을 롤백한다.</li><li>주문만 취소 상태로 변경하고 환불은 나중에 처리한다.</li></ol></li><li><p><strong>설계상 문제</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.order.application.service</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Service
</span></span><span style=display:flex><span>@RequiredArgsConstructor
</span></span><span style=display:flex><span>@Transactional
</span></span><span style=display:flex><span><span style=font-weight:700>public</span> <span style=font-weight:700>class</span> <span style=font-weight:700>OrderService</span> <span style=font-weight:700>implements</span> OrderUsecase {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-weight:700>private</span> <span style=font-weight:700>final</span> PaymentPort paymentPort;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	@Override
</span></span><span style=display:flex><span>  <span style=font-weight:700>public</span> <span>void</span> cancelOrder(Long orderId) {
</span></span><span style=display:flex><span>    <span style=font-weight:700>final</span> Order order = findOrder(orderId);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=font-style:italic>// Payment 도메인 로직
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>    <span style=font-weight:700>final</span> Boolean responseFromPayment = paymentPort.cancelPayment(order.getPaymentId());
</span></span><span style=display:flex><span>    <span style=font-weight:700>if</span> (!responseFromPayment) {
</span></span><span style=display:flex><span>      <span style=font-weight:700>throw</span> <span style=font-weight:700>new</span> RuntimeException(<span style=font-style:italic>&#34;결제 취소 실패&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=font-style:italic>// Order 도메인 로직
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>    order.cancelOrder();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>다른 도메인의 로직이 섞이고, 트랜잭션 처리 정책 및 외부 서비스 영향이 증가한다.</li></ul></li></ul><p><strong>→ 시스템의 결합도를 낮추기 위해 이벤트를 사용한다.</strong></p><ul><li><p>이벤트는 <strong>과거에 벌어진 어떤 것</strong>을 의미하며, <strong>상태가 변경</strong>됐다는 것을 의미한다.</p></li><li><p>이벤트는 다음과 같이 네 개의 구성요소를 가진다.
<img src=https://s3-us-west-2.amazonaws.com/secure.notion-static.com/18c5b9f6-7eaf-4d59-bdc1-c48d4b841c9a/68.png alt=68.png></p><ul><li><p>이벤트</p><ul><li>이벤트 종류, 발생 시간, 이벤트 관련 정보</li></ul></li><li><p>이벤트 생성 주체</p><ul><li>도메인 로직을 실행해서 <strong>상태가 바뀌면</strong> 관련 이벤트를 발생시킨다.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.delivery.application</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=font-weight:700>public</span> <span>void</span> startDelivery(Long deliveryId) {
</span></span><span style=display:flex><span>  <span style=font-weight:700>final</span> Delivery delivery = deliveryRepository.findById(deliveryId)
</span></span><span style=display:flex><span>      .orElseThrow(NoSuchElementException::<span style=font-weight:700>new</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  delivery.startDelivery();
</span></span><span style=display:flex><span>  deliveryEventPublisher.publish(<span style=font-weight:700>new</span> DeliveryStartedEvent(delivery));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>이벤트 디스패처</p><ul><li>핸들러에 <strong>이벤트를 전파</strong>한다.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.delivery.adapter.out</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-style:italic>// org.springframework.context.ApplicationEventPublisher
</span></span></span><span style=display:flex><span><span style=font-style:italic></span><span style=font-weight:700>private</span> <span style=font-weight:700>final</span> ApplicationEventPublisher publisher;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=font-weight:700>public</span> <span>void</span> publish(DeliveryEvent event) {
</span></span><span style=display:flex><span>  publisher.publishEvent(event);
</span></span><span style=display:flex><span>  log.info(<span style=font-style:italic>&#34;Order Event Published: {} {}&#34;</span>, event.getDelivery(), event.getTimestamp());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>이벤트 핸들러</p><ul><li>이벤트 생성 주체가 발생시킨 이벤트에 반응한다.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>package</span> <span style=font-weight:700>minjun.ddd.order.adapter.in</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@EventListener(DeliveryStartedEvent.class)
</span></span><span style=display:flex><span><span style=font-weight:700>public</span> <span>void</span> handleDeliveryStartedEvent(DeliveryStartedEvent event) {
</span></span><span style=display:flex><span>  orderUsecase.startDelivery(event.getDelivery().getOrderId());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul></li><li><p>위와 같은 방법이 아닌, <strong>메시징 시스템을 이용한 방법</strong>도 가능하다.</p><ul><li><p>이벤트 저장소를 이용한 메시징 (<strong>Transactional Outbox Pattern</strong>)</p></li><li><p>이벤트 발행 서비스</p><p><img src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/70ca4a0b-2a56-47f9-8c6c-c9c7ba585a76/transactional-outbox-pattern.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20220805%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20220805T161913Z&X-Amz-Expires=86400&X-Amz-Signature=e3993dd4d9fbc2d3e3d9d0b86323b679077999602777a60fb9fffea1f52d6409&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22transactional-outbox-pattern.png%22&x-id=GetObject" alt=transactional-outbox-pattern.png></p></li><li><p>이벤트 소비 서비스</p><p><img src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/f5151366-c200-4045-bbeb-47d2a485c2fb/idempotent-receiver.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20220805%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20220805T161925Z&X-Amz-Expires=86400&X-Amz-Signature=6e76e1ab692f7459c3b7c69a7aa8538902939a89ee25012173280bd8865a8e29&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22idempotent-receiver.png%22&x-id=GetObject" alt=idempotent-receiver.png></p></li></ul></li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2022
jo-minjun
·
<a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script></body></html>